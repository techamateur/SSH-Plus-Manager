#!/bin/bash
# createuser â€“ create SSH/OpenVPN user account (menu option [01] CREATE USER).

# Load color helpers (install path vs dev path)
if [[ -f /etc/SSHPlus/colors ]]; then
	source /etc/SSHPlus/colors
elif [[ -f /bin/colors ]]; then
	source /bin/colors
elif [[ -f "$(dirname "$0")/colors" ]]; then
	source "$(dirname "$0")/colors"
fi

# Load centralized DB + logging helpers
if [[ -f /etc/SSHPlus/db ]]; then
	source /etc/SSHPlus/db
elif [[ -f /bin/db ]]; then
	source /bin/db
elif [[ -f "$(dirname "$0")/db" ]]; then
	source "$(dirname "$0")/db"
fi
if [[ -z "${SSHPLUS_FROM_REPO:-}" ]]; then
	_mod_dir="$(cd "$(dirname "$0")" 2>/dev/null && pwd)"
	_repo_root="$(cd "${_mod_dir}/.." 2>/dev/null && pwd)"
	[[ -f "${_repo_root}/install.sh" ]] && [[ -f "${_repo_root}/version" ]] && export SSHPLUS_FROM_REPO=1
	unset -v _mod_dir _repo_root
fi

# IP: use /etc/IP if set, else detect and persist
if [[ -f /etc/IP ]] && [[ -s /etc/IP ]]; then
	IP=$(tr -d '\r\n' < /etc/IP)
else
	IP=$(hostname -I 2>/dev/null | awk '{print $1}')
	[[ -z "$IP" ]] && IP=$(wget -qO- --timeout=3 ipv4.icanhazip.com 2>/dev/null)
	[[ -z "$IP" ]] && IP=$(curl -sfL --max-time 3 ipv4.icanhazip.com 2>/dev/null)
	[[ -n "$IP" ]] && echo "$IP" > /etc/IP 2>/dev/null
	[[ -z "$IP" ]] && IP=""
fi

# Get SSH port (default 22, or first port from sshd_config)
_get_ssh_port() {
	local port
	port=$(grep -E '^[[:space:]]*Port[[:space:]]+' /etc/ssh/sshd_config 2>/dev/null | awk '{print $2}' | head -1)
	[[ -z "$port" ]] && port=22
	echo "$port"
}

# Generate npvt-ssh:// import link
_generate_npvt_link() {
	local username="$1" password="$2" ssh_host="$3" ssh_port="${4:-22}"
	[[ -z "$username" || -z "$password" || -z "$ssh_host" ]] && return 1

	local hostname_short
	hostname_short=$(hostname -s 2>/dev/null || hostname 2>/dev/null || echo "server")
	[[ -z "$hostname_short" ]] && hostname_short="server"
	local remarks="${username}@${hostname_short}"

	local json
	json=$(cat <<EOF
{"sshConfigType":"SSH-Direct","remarks":"${remarks}","sshHost":"${ssh_host}","sshPort":${ssh_port},"sshUsername":"${username}","sshPassword":"${password}","sni":"","tlsVersion":"DEFAULT","httpProxy":"","authenticateProxy":false,"proxyUsername":"","proxyPassword":"","payload":"","dnsTTMode":"UDP","dnsServer":"","nameserver":"","publicKey":"","udpgwPort":7300,"udpgwTransparentDNS":true}
EOF
)

	local encoded
	if command -v base64 >/dev/null 2>&1; then
		encoded=$(printf "%s" "$json" | base64 -w 0 2>/dev/null || printf "%s" "$json" | base64 2>/dev/null | tr -d '\n')
	elif command -v openssl >/dev/null 2>&1; then
		encoded=$(printf "%s" "$json" | openssl base64 2>/dev/null | tr -d '\n')
	else
		return 1
	fi

	printf "npvt-ssh://%s" "$encoded"
}
# Legacy ANSI vars (prefer msg_err/banner_info from colors); remove if unused
cor1='\033[41;1;37m'
cor2='\033[44;1;37m'
scor='\033[0m'
# Generate client.ovpn
newclient() {
    cp /etc/openvpn/client-common.txt ~/$1.ovpn
    echo "<ca>" >>~/$1.ovpn
    cat /etc/openvpn/easy-rsa/pki/ca.crt >>~/$1.ovpn
    echo "</ca>" >>~/$1.ovpn
    echo "<cert>" >>~/$1.ovpn
    cat /etc/openvpn/easy-rsa/pki/issued/$1.crt >>~/$1.ovpn
    echo "</cert>" >>~/$1.ovpn
    echo "<key>" >>~/$1.ovpn
    cat /etc/openvpn/easy-rsa/pki/private/$1.key >>~/$1.ovpn
    echo "</key>" >>~/$1.ovpn
    echo "<tls-auth>" >>~/$1.ovpn
    cat /etc/openvpn/ta.key >>~/$1.ovpn
    echo "</tls-auth>" >>~/$1.ovpn
}
fun_geraovpn() {
    [[ "$respost" = @(s|S) ]] && {
        cd /etc/openvpn/easy-rsa/
        ./easyrsa build-client-full $username nopass
        newclient "$username"
        sed -e "s;auth-user-pass;<auth-user-pass>\n$username\n$password\n</auth-user-pass>;g" /root/$username.ovpn >/root/tmp.ovpn && mv -f /root/tmp.ovpn /root/$username.ovpn
    } || {
        cd /etc/openvpn/easy-rsa/
        ./easyrsa build-client-full $username nopass
        newclient "$username"
    }
} >/dev/null 2>&1
[[ -e /etc/openvpn/server.conf ]] && {
    _Port=$(grep -w 'port' /etc/openvpn/server.conf | awk {'print $2'})
    hst=$(sed -n '8 p' /etc/openvpn/client-common.txt | awk {'print $4'})
    rmt=$(sed -n '7 p' /etc/openvpn/client-common.txt)
    hedr=$(sed -n '8 p' /etc/openvpn/client-common.txt)
    prxy=$(sed -n '9 p' /etc/openvpn/client-common.txt)
    rmt2='/SSHPLUS?'
    rmt3='www.vivo.com.br 8088'
    prx='200.142.130.104'
    payload1='#payload "HTTP/1.0 [crlf]Host: m.youtube.com[crlf]CONNECT HTTP/1.0[crlf][crlf]|[crlf]"'
    payload2='#payload "CONNECT 127.0.0.1:1194[split][crlf] HTTP/1.0 [crlf][crlf]#"'
    vivo1="portalrecarga.vivo.com.br/recarga"
    vivo2="portalrecarga.vivo.com.br/controle/"
    vivo3="navegue.vivo.com.br/pre/"
    vivo4="navegue.vivo.com.br/controle/"
    vivo5="www.vivo.com.br"
    oi="d1n212ccp6ldpw.cloudfront.net"
    bypass="net_gateway"
    cert01="/etc/openvpn/client-common.txt"
    if [[ "$hst" == "$vivo1" ]]; then
        Host="Portal Recharge"
    elif [[ "$hst" == "$vivo2" ]]; then
        Host="Recharge Control"
    elif [[ "$hst" == "$vivo3" ]]; then
        Host="Portal Browse"
    elif [[ "$hst" == "$vivo4" ]]; then
        Host="Nav control"
    elif [[ "$hst" == "$IP:$_Port" ]]; then
        Host="Vivo MMS"
    elif [[ "$hst" == "$oi" ]]; then
        Host="Oi"
    elif [[ "$hst" == "$bypass" ]]; then
        Host="Bypass mode"
    elif [[ "$hedr" == "$payload1" ]]; then
        Host="OPEN SOCKS"
    elif [[ "$hedr" == "$payload2" ]]; then
        Host="OPEN SQUID"
    else
        Host="Customized"
    fi
}
fun_bar() {
    command[0]="$1"
    command[1]="$2"
    (
        [[ -e $HOME/fim ]] && rm $HOME/fim
        ${command[0]} >/dev/null 2>&1
        ${command[1]} >/dev/null 2>&1
        touch $HOME/fim
    ) >/dev/null 2>&1 &
    tput civis
    # Use color functions for progress bar
    yellow_code=$(get_color_code "yellow")
    red_code=$(get_color_code "red")
    white_code=$(get_color_code "white")
    green_code=$(get_color_code "green")
    reset_code=$(get_reset_code)
    echo -ne "${yellow_code}WAIT ${white_code}- ${yellow_code}["
    while true; do
        for ((i = 0; i < 18; i++)); do
            echo -ne "${red_code}#"
            sleep 0.1s
        done
        [[ -e $HOME/fim ]] && rm $HOME/fim && break
        echo -e "${yellow_code}]"
        sleep 1s
        tput cuu1
        tput dl1
        echo -ne "${yellow_code}WAIT ${white_code}- ${yellow_code}["
    done
    echo -e "${yellow_code}]${white_code} -${green_code} OK !${white_code}${reset_code}"
    tput cnorm
}
fun_edithost() {
    clear
    # Use banner_info function for colored header
    banner_info "          CHANGE OVPN HOST            "
    echo ""
    # Use color functions for host display
    color_echo_n "HOST IN USE" "yellow"
    color_echo_n ": " "white"
    color_echo "$Host" "green"
    echo ""
    # Use menu_option function for menu items
    menu_option "1" "LIVE RECHARGE" "red" "yellow"
    menu_option "2" "LIVE NAVIGATOR" "red" "yellow"
    menu_option "3" "OPEN SOCKS [APP MOD]" "red" "yellow"
    menu_option "4" "OPEN SQUID [APP MOD]" "red" "yellow"
    menu_option "5" "VIVO MMS [APN: mms.vivo.com.br]" "red" "yellow"
    menu_option "6" "BYPASS MODE [OPEN + INJECTOR]" "red" "yellow"
    menu_option "7" "ALL HOSTS [1 OF EACH OVPN]" "red" "yellow"
    menu_option "8" "EDIT MANUALLY" "red" "yellow"
    menu_option "0" "BACK" "red" "yellow"
    echo ""
    color_echo_n "WHICH HOST YOU WANT TO USE " "green"
    color_echo_n "?" "yellow"
    color_echo_n " " "white"
    read respo
    [[ -z "$respo" ]] && {
        echo ""
        msg_err "Invalid option!"
        sleep 2
        fun_edithost
    }
    if [[ "$respo" = '1' ]]; then
        echo ""
        color_echo "CHANGING HOST!" "green"
        echo ""
        fun_althost() {
            sed -i "s;$rmt;remote $rmt2 $_Port;" $cert01
            sed -i "s;$hedr;http-proxy-option CUSTOM-HEADER Host $vivo1;" $cert01
            sed -i "s;$prxy;http-proxy $IP 80;" $cert01
        }
        fun_bar 'fun_althost'
        echo ""
        msg_ok "HOST CHANGED SUCCESSFULLY!"
        fun_geraovpn
        sleep 1.5
    elif [[ "$respo" = '2' ]]; then
        echo ""
        color_echo "CHANGING HOST!" "green"
        echo ""
        fun_althost2() {
            sed -i "s;$rmt;remote $rmt2 $_Port;" $cert01
            sed -i "s;$hedr;http-proxy-option CUSTOM-HEADER Host $vivo3;" $cert01
            sed -i "s;$prxy;http-proxy $IP 80;" $cert01
        }
        fun_bar 'fun_althost2'
        echo ""
        msg_ok "HOST CHANGED SUCCESSFULLY!"
        fun_geraovpn
        sleep 1.5
    elif [[ "$respo" = '3' ]]; then
        echo ""
        color_echo "CHANGING HOST!" "green"
        echo ""
        fun_althostpay1() {
            sed -i "s;$rmt;remote $rmt2 $_Port;" $cert01
            sed -i "s;$hedr;$payload1;" $cert01
            sed -i "s;$prxy;http-proxy $IP 8080;" $cert01
        }
        fun_bar 'fun_althostpay1'
        echo ""
        msg_ok "HOST CHANGED SUCCESSFULLY!"
        fun_geraovpn
        sleep 1.5
    elif [[ "$respo" = '4' ]]; then
        echo ""
        color_echo "CHANGING HOST!" "green"
        echo ""
        fun_althostpay2() {
            sed -i "s;$rmt;remote $rmt2 $_Port;" $cert01
            sed -i "s;$hedr;$payload2;" $cert01
            sed -i "s;$prxy;http-proxy $IP 80;" $cert01
        }
        fun_bar 'fun_althostpay2'
        echo ""
        msg_ok "HOST CHANGED SUCCESSFULLY!"
        fun_geraovpn
        sleep 1.5
    elif [[ "$respo" = '5' ]]; then
        echo ""
        color_echo "CHANGING HOST!" "green"
        echo ""
        fun_althost5() {
            sed -i "s;$rmt;remote $rmt3;" $cert01
            sed -i "s;$hedr;http-proxy-option CUSTOM-HEADER Host $IP:$_Port;" $cert01
            sed -i "s;$prxy;http-proxy $prx 80;" $cert01
        }
        fun_bar 'fun_althost5'
        echo ""
        msg_ok "HOST CHANGED SUCCESSFULLY!"
        fun_geraovpn
        sleep 1.5
    elif [[ "$respo" = '6' ]]; then
        echo ""
        color_echo "CHANGING HOST!" "green"
        echo ""
        fun_althost6() {
            sed -i "s;$rmt;remote $IP $_Port;" $cert01
            sed -i "s;$hedr;route $IP 255.255.255.255 net_gateway;" $cert01
            sed -i "s;$prxy;http-proxy 127.0.0.1 8989;" $cert01
        }
        fun_bar 'fun_althost6'
        echo ""
        msg_ok "HOST CHANGED SUCCESSFULLY!"
        fun_geraovpn
        sleep 1.5
    elif [[ "$respo" = '7' ]]; then
        [[ ! -e "$HOME/$username.ovpn" ]] && fun_geraovpn
        echo ""
        color_echo "CHANGING HOST!" "green"
        echo ""
        fun_packhost() {
            [[ ! -d "$HOME/OVPN" ]] && mkdir $HOME/OVPN
            sed -i "7,9"d $HOME/$username.ovpn
            sleep 0.5
            sed -i "7i\remote $rmt2 $_Port\nhttp-proxy-option CUSTOM-HEADER Host $vivo1\nhttp-proxy $IP 80" $HOME/$username.ovpn
            cp $HOME/$username.ovpn /root/OVPN/$username-vivo1.ovpn
            sed -i "8"d $HOME/$username.ovpn
            sleep 0.5
            sed -i "8i\http-proxy-option CUSTOM-HEADER Host $vivo3" $HOME/$username.ovpn
            cp $HOME/$username.ovpn /root/OVPN/$username-vivo2.ovpn
            sed -i "7,9"d $HOME/$username.ovpn
            sleep 0.5
            sed -i "7i\remote $rmt3\nhttp-proxy-option CUSTOM-HEADER Host $IP:$_Port\nhttp-proxy $prx 80" $HOME/$username.ovpn
            cp $HOME/$username.ovpn /root/OVPN/$username-vivo3.ovpn
            sed -i "7,9"d $HOME/$username.ovpn
            sleep 0.5
            sed -i "7i\remote $IP $_Port\nroute $IP 255.255.255.255 net_gateway\nhttp-proxy 127.0.0.1 8989" $HOME/$username.ovpn
            cp $HOME/$username.ovpn /root/OVPN/$username-bypass.ovpn
			sed -i "7,9"d $HOME/$username.ovpn
			sleep 0.5
			sed -i "7i\remote $rmt2 $_Port\n$payload1\nhttp-proxy $IP 8080" $HOME/$username.ovpn
            cp $HOME/$username.ovpn /root/OVPN/$username-socks.ovpn
			sed -i "7,9"d $HOME/$username.ovpn
			sleep 0.5
			sed -i "7i\remote $rmt2 $_Port\n$payload2\nhttp-proxy $IP 80" $HOME/$username.ovpn
            cp $HOME/$username.ovpn /root/OVPN/$username-squid.ovpn
            cd $HOME/OVPN && zip $username.zip *.ovpn >/dev/null 2>&1 && cp $username.zip $HOME/$username.zip
            cd $HOME && rm -rf /root/OVPN >/dev/null 2>&1
        }
        fun_bar 'fun_packhost'
        echo ""
        msg_ok "HOST CHANGED SUCCESSFULLY!"
        sleep 1.5
    elif [[ "$respo" = '8' ]]; then
        echo ""
        color_echo "CHANGING OVPN FILE!" "green"
        echo ""
        msg_err "ATTENTION!"
        echo ""
        color_echo_n "TO SAVE USE THE KEYS " "yellow"
        color_echo "ctrl x y" "green"
        sleep 4
        clear
        nano /etc/openvpn/client-common.txt
        echo ""
        msg_ok "CHANGED SUCCESSFULLY!"
        fun_geraovpn
        sleep 1.5
    elif [[ "$respo" = '0' ]]; then
        echo ""
        msg_err "Returning..."
        sleep 2
    else
        echo ""
        msg_err "Invalid option !"
        sleep 2
        fun_edithost
    fi
}
[[ -z "${SSHPLUS_FROM_REPO:-}" ]] && [[ ! -e /usr/lib/sshplus ]] && exit 0
clear
tput setaf 7;tput setab 4;tput bold;printf '%30s%s%-15s\n' "Create SSH User";tput sgr0
echo ""
color_echo_n "Enter new username to create user (0=back 00=exit): " "green"
read -r username
username="${username//[[:space:]]/}"
[[ "$username" == "0" ]] && exit 0
[[ "$username" == "00" ]] && exit 99
[[ -z "$username" ]] && {
	echo ""
	msg_err "Empty or invalid username!"
	echo ""
	exit 1
}
[[ "$(grep -wc $username /etc/passwd)" != '0' ]] && {
	echo ""
	msg_err "This user already exists. try another name!"
	echo ""
	exit 1
}
[[ ${username} != ?(+|-)+([a-zA-Z0-9]) ]] && {
	echo ""
	msg_err "You entered an invalid username!"
	msg_err "Do not use spaces, accents or special characters!"
	echo ""
	exit 1
}
sizemin=$(echo ${#username})
[[ $sizemin -lt 2 ]] && {
	echo ""
	msg_err "You entered a very short username"
	msg_err "use at least two characters!"
	echo ""
	exit 1
}
sizemax=$(echo ${#username})
[[ $sizemax -gt 10 ]] && {
	echo ""
	msg_err "You entered a very long username"
	msg_err "use a maximum of 10 characters!"
	echo ""
	exit 1
}
color_echo_n "Password: " "green"
read -r password
[[ -z $password ]] && {
	echo ""
	msg_err "Password empty or invalid!"
	echo ""
	exit 1
}
sizepass=$(echo ${#password})
[[ $sizepass -lt 4 ]] && {
	echo ""
	msg_err "Short password !, use at least 4 characters"
	echo ""
	exit 1
}
color_echo_n "Days to expire: " "green"
read -r dias
[[ -z $dias ]] && {
	echo ""
	msg_err "No number of days!"
	echo ""
	exit 1
}
[[ ${dias} != ?(+|-)+([0-9]) ]] && {
	echo ""
	msg_err "You entered an invalid number of days!"
	echo ""
	exit 1
}
[[ $dias -lt 1 ]] && {
	echo ""
	msg_err "The number must be greater than zero!"
	echo ""
	exit 1
}
color_echo_n "Connection limit: " "green"
read -r sshlimiter
[[ -z $sshlimiter ]] && {
	echo ""
	msg_err "You left the connection limit empty!"
	echo ""
	exit 1
}
[[ ${sshlimiter} != ?(+|-)+([0-9]) ]] && {
	echo ""
	msg_err "You entered an invalid number of connection!"
	echo ""
	exit 1
}
[[ $sshlimiter -lt 1 ]] && {
	echo ""
	msg_err "Number of simultaneous connections must be greater than zero!"
	echo ""
	exit 1
}
final=$(date "+%Y-%m-%d" -d "+$dias days")
gui=$(date "+%d/%m/%Y" -d "+$dias days")
# Create system user, then set password through the service (no `passwd` usage)
useradd -e "$final" -M -s /bin/false "$username" >/dev/null 2>&1 || {
	echo ""
	msg_err "Failed to create user $username"
	echo ""
	exit 1
}
if ! sshplus_set_system_password "$username" "$password"; then
	# Keep DB/system consistent: if password set fails, delete the user and stop
	userdel -f "$username" >/dev/null 2>&1 || true
	echo ""
	msg_err "Failed to set password for $username"
	echo ""
	exit 1
fi

# Record in centralized DB (single source of truth)
sshplus_with_db_lock sshplus_db_put_user \
	"$username" \
	"$sshlimiter" \
	"$final" \
	"$(sshplus_now_date)" \
	0 \
	0 \
	"never" \
	"$(sshplus_hash_password "$password")" || true
[[ -e /etc/openvpn/server.conf ]] && {
	color_echo_n "Generate Ovpn File " "green"
	color_echo_n "? " "red"
	color_echo_n "[y/n]: " "yellow"
	read -r resp
	[[ "$resp" = @(y|Y) ]] && {
		rm $username.zip $username.ovpn >/dev/null 2>&1
		color_echo_n "Generate with username and password " "green"
		color_echo_n "? " "red"
		color_echo_n "[y/n]: " "yellow"
		read respost
		color_echo_n "Current Host" "green"
		color_echo_n ": " "white"
		color_echo_n "(" "red"
		color_echo_n "$Host" "white"
		color_echo_n ") " "red"
		color_echo_n "- " "white"
		color_echo_n "Change " "green"
		color_echo_n "? " "red"
		color_echo_n "[y/n]: " "yellow"
		read -r oprc
		[[ "$oprc" = @(y|Y) ]] && {
			fun_edithost
		} || {
			fun_geraovpn
		}
		gerarovpn() {
			[[ ! -e "/root/$username.zip" ]] && {
				zip /root/$username.zip /root/$username.ovpn
				sleep 1.5
			}
		}
		clear
		banner_info "       SSH ACCOUNT CREATED !      "
		# Use color functions for account info display
		echo ""
		# Ensure IP is set
		if [[ -z "$IP" ]] || [[ "$IP" == "" ]]; then
			if [[ -f /etc/IP ]] && [[ -s /etc/IP ]]; then
				IP=$(cat /etc/IP)
			else
				IP=$(hostname -I | awk '{print $1}' 2>/dev/null)
				[[ -z "$IP" ]] && IP=$(wget -qO- ipv4.icanhazip.com 2>/dev/null)
				[[ -z "$IP" ]] && IP=$(curl -s ipv4.icanhazip.com 2>/dev/null)
				[[ -z "$IP" ]] && IP="N/A"
			fi
		fi
		color_echo_n "IP: " "green"
		color_echo "$IP" "white"
		color_echo_n "User: " "green"
		color_echo "$username" "white"
		color_echo_n "Password: " "green"
		color_echo "$password" "white"
		color_echo_n "Expires in: " "green"
		color_echo "$gui" "white"
		color_echo_n "Connection limit: " "green"
		color_echo "$sshlimiter" "white"
		# Generate and display npvt-ssh:// import link
		_ssh_port=$(_get_ssh_port)
		_import_link=$(_generate_npvt_link "$username" "$password" "$IP" "$_ssh_port")
		if [[ -n "$_import_link" ]]; then
			echo ""
			color_echo_n "Import link: " "green"
			color_echo "$_import_link" "cyan"
		fi
		sleep 1
		function aguarde() {
			helice() {
				gerarovpn >/dev/null 2>&1 &
				tput civis
				while [ -d /proc/$! ]; do
					for i in / - \\ \|; do
						sleep .1
						echo -ne "\e[1D$i"
					done
				done
				tput cnorm
			}
			echo ""
			color_echo_n "CREATING OVPN" "red"
			color_echo_n "." "yellow"
			color_echo_n ". " "red"
			color_echo_n "" "green"
			helice
			echo -e "\e[1DOK"
		}
		aguarde
		VERSION_ID=$(cat /etc/os-release | grep "VERSION_ID")
		echo ""
		[[ -d /var/www/html/openvpn ]] && {
			mv $HOME/$username.zip /var/www/html/openvpn/$username.zip >/dev/null 2>&1
			[[ "$VERSION_ID" = 'VERSION_ID="14.04"' ]] && {
				color_echo_n "LINK: " "green"
			color_echo "$IP:81/html/openvpn/$username.zip" "cyan"
			} || {
				color_echo_n "LINK: " "green"
				color_echo "$IP:81/openvpn/$username.zip" "cyan"
			}
		} || {
			color_echo_n "Available in" "green"
			color_echo " ~/$username.zip" "red"
			sleep 1
		}
	} || {
		clear
		banner_info "       SSH ACCOUNT CREATED !      "
		# Use color functions for account info display
		echo ""
		# Ensure IP is set
		if [[ -z "$IP" ]] || [[ "$IP" == "" ]]; then
			if [[ -f /etc/IP ]] && [[ -s /etc/IP ]]; then
				IP=$(cat /etc/IP)
			else
				IP=$(hostname -I | awk '{print $1}' 2>/dev/null)
				[[ -z "$IP" ]] && IP=$(wget -qO- ipv4.icanhazip.com 2>/dev/null)
				[[ -z "$IP" ]] && IP=$(curl -s ipv4.icanhazip.com 2>/dev/null)
				[[ -z "$IP" ]] && IP="N/A"
			fi
		fi
		color_echo_n "IP: " "green"
		color_echo "$IP" "white"
		color_echo_n "User: " "green"
		color_echo "$username" "white"
		color_echo_n "Password: " "green"
		color_echo "$password" "white"
		color_echo_n "Expires in: " "green"
		color_echo "$gui" "white"
		color_echo_n "Connection limit: " "green"
		color_echo "$sshlimiter" "white"
		# Generate and display npvt-ssh:// import link
		_ssh_port=$(_get_ssh_port)
		_import_link=$(_generate_npvt_link "$username" "$password" "$IP" "$_ssh_port")
		if [[ -n "$_import_link" ]]; then
			echo ""
			color_echo_n "Import link: " "green"
			color_echo "$_import_link" "cyan"
		fi
	}
} || {
	clear
	banner_info "       SSH ACCOUNT CREATED !      "
	# Use color functions for account info display
	echo ""
	# Ensure IP is set (same fallback as other branches)
	if [[ -z "$IP" ]]; then
		if [[ -f /etc/IP ]] && [[ -s /etc/IP ]]; then
			IP=$(cat /etc/IP)
		else
			IP=$(hostname -I 2>/dev/null | awk '{print $1}')
			[[ -z "$IP" ]] && IP=$(wget -qO- ipv4.icanhazip.com 2>/dev/null)
			[[ -z "$IP" ]] && IP=$(curl -s ipv4.icanhazip.com 2>/dev/null)
			[[ -n "$IP" ]] && echo "$IP" > /etc/IP 2>/dev/null
			[[ -z "$IP" ]] && IP="N/A"
		fi
	fi
	color_echo_n "IP: " "green"
	color_echo "$IP" "white"
	color_echo_n "User: " "green"
	color_echo "$username" "white"
	color_echo_n "Password: " "green"
	color_echo "$password" "white"
	color_echo_n "Expires in: " "green"
	color_echo "$gui" "white"
	color_echo_n "Connection limit: " "green"
	color_echo "$sshlimiter" "white"
	# Generate and display npvt-ssh:// import link
	_ssh_port=$(_get_ssh_port)
	_import_link=$(_generate_npvt_link "$username" "$password" "$IP" "$_ssh_port")
	if [[ -n "$_import_link" ]]; then
		echo ""
		color_echo_n "Import link: " "green"
		color_echo "$_import_link" "cyan"
	fi
}
