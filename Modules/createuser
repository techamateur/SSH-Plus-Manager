#!/bin/bash
# createuser â€“ create SSH/OpenVPN user account (menu option [01] CREATE USER).

# Load color helpers (install path vs dev path)
if [[ -f /etc/SSHPlus/colors ]]; then
	source /etc/SSHPlus/colors
elif [[ -f /bin/colors ]]; then
	source /bin/colors
elif [[ -f "$(dirname "$0")/colors" ]]; then
	source "$(dirname "$0")/colors"
fi

# Load centralized DB + logging helpers
if [[ -f /etc/SSHPlus/db ]]; then
	source /etc/SSHPlus/db
elif [[ -f /bin/db ]]; then
	source /bin/db
elif [[ -f "$(dirname "$0")/db" ]]; then
	source "$(dirname "$0")/db"
fi
# db sets "nounset" globally; disable it for interactive prompts here
set +o nounset 2>/dev/null || true
if [[ -z "${SSHPLUS_FROM_REPO:-}" ]]; then
	_mod_dir="$(cd "$(dirname "$0")" 2>/dev/null && pwd)"
	_repo_root="$(cd "${_mod_dir}/.." 2>/dev/null && pwd)"
	[[ -f "${_repo_root}/install.sh" ]] && [[ -f "${_repo_root}/version" ]] && export SSHPLUS_FROM_REPO=1
	unset -v _mod_dir _repo_root
fi

# IP: use /etc/IP if set, else detect and persist
if [[ -f /etc/IP ]] && [[ -s /etc/IP ]]; then
	IP=$(tr -d '\r\n' < /etc/IP)
else
	IP=$(hostname -I 2>/dev/null | awk '{print $1}')
	[[ -z "$IP" ]] && IP=$(wget -qO- --timeout=3 ipv4.icanhazip.com 2>/dev/null)
	[[ -z "$IP" ]] && IP=$(curl -sfL --max-time 3 ipv4.icanhazip.com 2>/dev/null)
	[[ -n "$IP" ]] && echo "$IP" > /etc/IP 2>/dev/null
	[[ -z "$IP" ]] && IP=""
fi

# Get SSH port (default 22, or first port from sshd_config)
_get_ssh_port() {
	local port
	port=$(grep -E '^[[:space:]]*Port[[:space:]]+' /etc/ssh/sshd_config 2>/dev/null | awk '{print $2}' | head -1)
	[[ -z "$port" ]] && port=22
	echo "$port"
}

# -------------------- npvt-ssh:// helpers --------------------
_json_escape() {
	# Minimal JSON string escaping for remarks/host/user/pass fields.
	# Escapes: backslash, double-quote, newlines, carriage returns, tabs.
	local s="${1:-}"
	s=${s//\\/\\\\}
	s=${s//\"/\\\"}
	s=${s//$'\n'/\\n}
	s=${s//$'\r'/\\r}
	s=${s//$'\t'/\\t}
	printf "%s" "$s"
}

_build_npvt_json() {
	# Prints single-line JSON exactly (no trailing newline)
	# Args: remarks host port username password sni tlsVersion dnsTTMode udpgwPort
	local remarks="$1" ssh_host="$2" ssh_port="$3" username="$4" password="$5"
	local sni="${6:-}" tlsVersion="${7:-DEFAULT}" dnsTTMode="${8:-UDP}" udpgwPort="${9:-7300}"

	printf '{"sshConfigType":"SSH-Direct","remarks":"%s","sshHost":"%s","sshPort":%s,"sshUsername":"%s","sshPassword":"%s","sni":"%s","tlsVersion":"%s","httpProxy":"","authenticateProxy":false,"proxyUsername":"","proxyPassword":"","payload":"","dnsTTMode":"%s","dnsServer":"","nameserver":"","publicKey":"","udpgwPort":%s,"udpgwTransparentDNS":true}' \
		"$(_json_escape "$remarks")" \
		"$(_json_escape "$ssh_host")" \
		"${ssh_port:-22}" \
		"$(_json_escape "$username")" \
		"$(_json_escape "$password")" \
		"$(_json_escape "$sni")" \
		"$(_json_escape "$tlsVersion")" \
		"$(_json_escape "$dnsTTMode")" \
		"${udpgwPort:-7300}"
}

_b64_encode() {
	# Base64 encode stdin to single line (no newlines)
	if command -v base64 >/dev/null 2>&1; then
		base64 -w 0 2>/dev/null || base64 2>/dev/null | tr -d '\n'
		return 0
	fi
	if command -v openssl >/dev/null 2>&1; then
		openssl base64 2>/dev/null | tr -d '\n'
		return 0
	fi
	return 1
}

_npvt_link_from_json() {
	local json="${1:-}"
	[[ -z "$json" ]] && return 1
	local encoded
	encoded="$(printf "%s" "$json" | _b64_encode)" || return 1
	printf "npvt-ssh://%s" "$encoded"
}

_gen_password() {
	# Generates a reasonably copy-friendly password (min 8 chars).
	if command -v openssl >/dev/null 2>&1; then
		openssl rand -base64 12 2>/dev/null | tr -d '\n' | tr -d '=+/' | cut -c1-12
		return 0
	fi
	tr -dc 'A-Za-z0-9' </dev/urandom 2>/dev/null | head -c 12
}

_is_int() { [[ "${1:-}" =~ ^[0-9]+$ ]]; }

_detect_public_ipv4() {
	# Prefer /etc/IP; fallback to hostname -I; fallback to curl/wget
	local ip=""
	if [[ -f /etc/IP ]] && [[ -s /etc/IP ]]; then
		ip=$(tr -d '\r\n' < /etc/IP)
	fi
	[[ -z "$ip" ]] && ip=$(hostname -I 2>/dev/null | awk '{print $1}')
	if [[ -z "$ip" ]] && command -v curl >/dev/null 2>&1; then
		ip=$(curl -sfL --max-time 3 ipv4.icanhazip.com 2>/dev/null | tr -d '\r\n')
	fi
	if [[ -z "$ip" ]] && command -v wget >/dev/null 2>&1; then
		ip=$(wget -qO- --timeout=3 ipv4.icanhazip.com 2>/dev/null | tr -d '\r\n')
	fi
	printf "%s" "$ip"
}

_hostname_short() {
	local h
	h=$(hostname -s 2>/dev/null || hostname 2>/dev/null || true)
	[[ -z "$h" ]] && h="server"
	printf "%s" "$h"
}

_print_kv_aligned() {
	# Args: label value (label includes emoji)
	local label="$1" value="$2"
	printf "%b%-18s%b %b%s%b\n" "$(c ui_label)" "$label" "$(reset)" "$(c ui_value)" "$value" "$(reset)"
}
# Legacy ANSI vars (prefer msg_err/banner_info from colors); remove if unused
cor1='\033[41;1;37m'
cor2='\033[44;1;37m'
scor='\033[0m'
# Generate client.ovpn
newclient() {
    cp /etc/openvpn/client-common.txt ~/$1.ovpn
    echo "<ca>" >>~/$1.ovpn
    cat /etc/openvpn/easy-rsa/pki/ca.crt >>~/$1.ovpn
    echo "</ca>" >>~/$1.ovpn
    echo "<cert>" >>~/$1.ovpn
    cat /etc/openvpn/easy-rsa/pki/issued/$1.crt >>~/$1.ovpn
    echo "</cert>" >>~/$1.ovpn
    echo "<key>" >>~/$1.ovpn
    cat /etc/openvpn/easy-rsa/pki/private/$1.key >>~/$1.ovpn
    echo "</key>" >>~/$1.ovpn
    echo "<tls-auth>" >>~/$1.ovpn
    cat /etc/openvpn/ta.key >>~/$1.ovpn
    echo "</tls-auth>" >>~/$1.ovpn
}
fun_geraovpn() {
    [[ "$respost" = @(s|S) ]] && {
        cd /etc/openvpn/easy-rsa/
        ./easyrsa build-client-full $username nopass
        newclient "$username"
        sed -e "s;auth-user-pass;<auth-user-pass>\n$username\n$password\n</auth-user-pass>;g" /root/$username.ovpn >/root/tmp.ovpn && mv -f /root/tmp.ovpn /root/$username.ovpn
    } || {
        cd /etc/openvpn/easy-rsa/
        ./easyrsa build-client-full $username nopass
        newclient "$username"
    }
} >/dev/null 2>&1
[[ -e /etc/openvpn/server.conf ]] && {
    _Port=$(grep -w 'port' /etc/openvpn/server.conf | awk {'print $2'})
    hst=$(sed -n '8 p' /etc/openvpn/client-common.txt | awk {'print $4'})
    rmt=$(sed -n '7 p' /etc/openvpn/client-common.txt)
    hedr=$(sed -n '8 p' /etc/openvpn/client-common.txt)
    prxy=$(sed -n '9 p' /etc/openvpn/client-common.txt)
    rmt2='/SSHPLUS?'
    rmt3='www.vivo.com.br 8088'
    prx='200.142.130.104'
    payload1='#payload "HTTP/1.0 [crlf]Host: m.youtube.com[crlf]CONNECT HTTP/1.0[crlf][crlf]|[crlf]"'
    payload2='#payload "CONNECT 127.0.0.1:1194[split][crlf] HTTP/1.0 [crlf][crlf]#"'
    vivo1="portalrecarga.vivo.com.br/recarga"
    vivo2="portalrecarga.vivo.com.br/controle/"
    vivo3="navegue.vivo.com.br/pre/"
    vivo4="navegue.vivo.com.br/controle/"
    vivo5="www.vivo.com.br"
    oi="d1n212ccp6ldpw.cloudfront.net"
    bypass="net_gateway"
    cert01="/etc/openvpn/client-common.txt"
    if [[ "$hst" == "$vivo1" ]]; then
        Host="Portal Recharge"
    elif [[ "$hst" == "$vivo2" ]]; then
        Host="Recharge Control"
    elif [[ "$hst" == "$vivo3" ]]; then
        Host="Portal Browse"
    elif [[ "$hst" == "$vivo4" ]]; then
        Host="Nav control"
    elif [[ "$hst" == "$IP:$_Port" ]]; then
        Host="Vivo MMS"
    elif [[ "$hst" == "$oi" ]]; then
        Host="Oi"
    elif [[ "$hst" == "$bypass" ]]; then
        Host="Bypass mode"
    elif [[ "$hedr" == "$payload1" ]]; then
        Host="OPEN SOCKS"
    elif [[ "$hedr" == "$payload2" ]]; then
        Host="OPEN SQUID"
    else
        Host="Customized"
    fi
}
fun_bar() {
    command[0]="$1"
    command[1]="$2"
    (
        [[ -e $HOME/fim ]] && rm $HOME/fim
        ${command[0]} >/dev/null 2>&1
        ${command[1]} >/dev/null 2>&1
        touch $HOME/fim
    ) >/dev/null 2>&1 &
    tput civis
    # Use color functions for progress bar
    yellow_code=$(get_color_code "yellow")
    red_code=$(get_color_code "red")
    white_code=$(get_color_code "white")
    green_code=$(get_color_code "green")
    reset_code=$(get_reset_code)
    echo -ne "${yellow_code}WAIT ${white_code}- ${yellow_code}["
    while true; do
        for ((i = 0; i < 18; i++)); do
            echo -ne "${red_code}#"
            sleep 0.1s
        done
        [[ -e $HOME/fim ]] && rm $HOME/fim && break
        echo -e "${yellow_code}]"
        sleep 1s
        tput cuu1
        tput dl1
        echo -ne "${yellow_code}WAIT ${white_code}- ${yellow_code}["
    done
    echo -e "${yellow_code}]${white_code} -${green_code} OK !${white_code}${reset_code}"
    tput cnorm
}
fun_edithost() {
    clear
    # Use banner_info function for colored header
    banner_info "          CHANGE OVPN HOST            "
    echo ""
    # Use color functions for host display
    color_echo_n "HOST IN USE" "yellow"
    color_echo_n ": " "white"
    color_echo "$Host" "green"
    echo ""
    # Use menu_option function for menu items
    menu_option "1" "LIVE RECHARGE" "red" "yellow"
    menu_option "2" "LIVE NAVIGATOR" "red" "yellow"
    menu_option "3" "OPEN SOCKS [APP MOD]" "red" "yellow"
    menu_option "4" "OPEN SQUID [APP MOD]" "red" "yellow"
    menu_option "5" "VIVO MMS [APN: mms.vivo.com.br]" "red" "yellow"
    menu_option "6" "BYPASS MODE [OPEN + INJECTOR]" "red" "yellow"
    menu_option "7" "ALL HOSTS [1 OF EACH OVPN]" "red" "yellow"
    menu_option "8" "EDIT MANUALLY" "red" "yellow"
    menu_option "0" "BACK" "red" "yellow"
    echo ""
    color_echo_n "WHICH HOST YOU WANT TO USE " "green"
    color_echo_n "?" "yellow"
    color_echo_n " " "white"
    read respo
    [[ -z "$respo" ]] && {
        echo ""
        msg_err "Invalid option!"
        sleep 2
        fun_edithost
    }
    if [[ "$respo" = '1' ]]; then
        echo ""
        color_echo "CHANGING HOST!" "green"
        echo ""
        fun_althost() {
            sed -i "s;$rmt;remote $rmt2 $_Port;" $cert01
            sed -i "s;$hedr;http-proxy-option CUSTOM-HEADER Host $vivo1;" $cert01
            sed -i "s;$prxy;http-proxy $IP 80;" $cert01
        }
        fun_bar 'fun_althost'
        echo ""
        msg_ok "HOST CHANGED SUCCESSFULLY!"
        fun_geraovpn
        sleep 1.5
    elif [[ "$respo" = '2' ]]; then
        echo ""
        color_echo "CHANGING HOST!" "green"
        echo ""
        fun_althost2() {
            sed -i "s;$rmt;remote $rmt2 $_Port;" $cert01
            sed -i "s;$hedr;http-proxy-option CUSTOM-HEADER Host $vivo3;" $cert01
            sed -i "s;$prxy;http-proxy $IP 80;" $cert01
        }
        fun_bar 'fun_althost2'
        echo ""
        msg_ok "HOST CHANGED SUCCESSFULLY!"
        fun_geraovpn
        sleep 1.5
    elif [[ "$respo" = '3' ]]; then
        echo ""
        color_echo "CHANGING HOST!" "green"
        echo ""
        fun_althostpay1() {
            sed -i "s;$rmt;remote $rmt2 $_Port;" $cert01
            sed -i "s;$hedr;$payload1;" $cert01
            sed -i "s;$prxy;http-proxy $IP 8080;" $cert01
        }
        fun_bar 'fun_althostpay1'
        echo ""
        msg_ok "HOST CHANGED SUCCESSFULLY!"
        fun_geraovpn
        sleep 1.5
    elif [[ "$respo" = '4' ]]; then
        echo ""
        color_echo "CHANGING HOST!" "green"
        echo ""
        fun_althostpay2() {
            sed -i "s;$rmt;remote $rmt2 $_Port;" $cert01
            sed -i "s;$hedr;$payload2;" $cert01
            sed -i "s;$prxy;http-proxy $IP 80;" $cert01
        }
        fun_bar 'fun_althostpay2'
        echo ""
        msg_ok "HOST CHANGED SUCCESSFULLY!"
        fun_geraovpn
        sleep 1.5
    elif [[ "$respo" = '5' ]]; then
        echo ""
        color_echo "CHANGING HOST!" "green"
        echo ""
        fun_althost5() {
            sed -i "s;$rmt;remote $rmt3;" $cert01
            sed -i "s;$hedr;http-proxy-option CUSTOM-HEADER Host $IP:$_Port;" $cert01
            sed -i "s;$prxy;http-proxy $prx 80;" $cert01
        }
        fun_bar 'fun_althost5'
        echo ""
        msg_ok "HOST CHANGED SUCCESSFULLY!"
        fun_geraovpn
        sleep 1.5
    elif [[ "$respo" = '6' ]]; then
        echo ""
        color_echo "CHANGING HOST!" "green"
        echo ""
        fun_althost6() {
            sed -i "s;$rmt;remote $IP $_Port;" $cert01
            sed -i "s;$hedr;route $IP 255.255.255.255 net_gateway;" $cert01
            sed -i "s;$prxy;http-proxy 127.0.0.1 8989;" $cert01
        }
        fun_bar 'fun_althost6'
        echo ""
        msg_ok "HOST CHANGED SUCCESSFULLY!"
        fun_geraovpn
        sleep 1.5
    elif [[ "$respo" = '7' ]]; then
        [[ ! -e "$HOME/$username.ovpn" ]] && fun_geraovpn
        echo ""
        color_echo "CHANGING HOST!" "green"
        echo ""
        fun_packhost() {
            [[ ! -d "$HOME/OVPN" ]] && mkdir $HOME/OVPN
            sed -i "7,9"d $HOME/$username.ovpn
            sleep 0.5
            sed -i "7i\remote $rmt2 $_Port\nhttp-proxy-option CUSTOM-HEADER Host $vivo1\nhttp-proxy $IP 80" $HOME/$username.ovpn
            cp $HOME/$username.ovpn /root/OVPN/$username-vivo1.ovpn
            sed -i "8"d $HOME/$username.ovpn
            sleep 0.5
            sed -i "8i\http-proxy-option CUSTOM-HEADER Host $vivo3" $HOME/$username.ovpn
            cp $HOME/$username.ovpn /root/OVPN/$username-vivo2.ovpn
            sed -i "7,9"d $HOME/$username.ovpn
            sleep 0.5
            sed -i "7i\remote $rmt3\nhttp-proxy-option CUSTOM-HEADER Host $IP:$_Port\nhttp-proxy $prx 80" $HOME/$username.ovpn
            cp $HOME/$username.ovpn /root/OVPN/$username-vivo3.ovpn
            sed -i "7,9"d $HOME/$username.ovpn
            sleep 0.5
            sed -i "7i\remote $IP $_Port\nroute $IP 255.255.255.255 net_gateway\nhttp-proxy 127.0.0.1 8989" $HOME/$username.ovpn
            cp $HOME/$username.ovpn /root/OVPN/$username-bypass.ovpn
			sed -i "7,9"d $HOME/$username.ovpn
			sleep 0.5
			sed -i "7i\remote $rmt2 $_Port\n$payload1\nhttp-proxy $IP 8080" $HOME/$username.ovpn
            cp $HOME/$username.ovpn /root/OVPN/$username-socks.ovpn
			sed -i "7,9"d $HOME/$username.ovpn
			sleep 0.5
			sed -i "7i\remote $rmt2 $_Port\n$payload2\nhttp-proxy $IP 80" $HOME/$username.ovpn
            cp $HOME/$username.ovpn /root/OVPN/$username-squid.ovpn
            cd $HOME/OVPN && zip $username.zip *.ovpn >/dev/null 2>&1 && cp $username.zip $HOME/$username.zip
            cd $HOME && rm -rf /root/OVPN >/dev/null 2>&1
        }
        fun_bar 'fun_packhost'
        echo ""
        msg_ok "HOST CHANGED SUCCESSFULLY!"
        sleep 1.5
    elif [[ "$respo" = '8' ]]; then
        echo ""
        color_echo "CHANGING OVPN FILE!" "green"
        echo ""
        msg_err "ATTENTION!"
        echo ""
        color_echo_n "TO SAVE USE THE KEYS " "yellow"
        color_echo "ctrl x y" "green"
        sleep 4
        clear
        nano /etc/openvpn/client-common.txt
        echo ""
        msg_ok "CHANGED SUCCESSFULLY!"
        fun_geraovpn
        sleep 1.5
    elif [[ "$respo" = '0' ]]; then
        echo ""
        msg_err "Returning..."
        sleep 2
    else
        echo ""
        msg_err "Invalid option !"
        sleep 2
        fun_edithost
    fi
}
[[ -z "${SSHPLUS_FROM_REPO:-}" ]] && [[ ! -e /usr/lib/sshplus ]] && exit 0
clear

# -------------------- new Create User UX --------------------
while true; do
	title_line "CREATE USER"

	# Username
	printf "%bðŸ‘¤ Username:%b " "$(c ui_label)" "$(reset)"
	read -r username
	username="${username//[[:space:]]/}"
	[[ "$username" == "0" ]] && exit 0
	[[ "$username" == "00" ]] && exit 99
	if [[ -z "$username" ]]; then
		msg_err "Username is required."
		sleep 1
		clear
		continue
	fi
	if [[ "$(grep -wc "$username" /etc/passwd 2>/dev/null)" != '0' ]]; then
		msg_err "This user already exists. Try another name."
		sleep 1
		clear
		continue
	fi
	if ! [[ "$username" =~ ^[a-zA-Z0-9][a-zA-Z0-9_-]{1,9}$ ]]; then
		msg_err "Invalid username. Use 2-10 chars: letters/numbers/_/-"
		sleep 1
		clear
		continue
	fi

	# Defaults derived after username
	_default_host="$(_detect_public_ipv4)"
	_default_port="$(_get_ssh_port)"
	_default_remark="${username}@$(_hostname_short)"
	_default_days="98"
	_default_limit="2"

	# Password
	printf "%bðŸ”’ Password:%b %b[auto]%b  (Enter to generate)\n" "$(c ui_label)" "$(reset)" "$(c muted)" "$(reset)"
	printf "%b> %b" "$(c ui_prompt)" "$(reset)"
	read -r password
	if [[ -z "$password" ]]; then
		password="$(_gen_password)"
	fi
	if [[ ${#password} -lt 4 ]]; then
		msg_err "Password too short (min 4)."
		sleep 1
		clear
		continue
	fi

	# Remark
	printf "%bðŸ· Remark:%b [%s] " "$(c ui_label)" "$(reset)" "$_default_remark"
	read -r remarks
	[[ -z "$remarks" ]] && remarks="$_default_remark"

	# Host / port
	printf "%bðŸŒ SSH Host:%b [%s] " "$(c ui_label)" "$(reset)" "${_default_host:-}"
	read -r ssh_host
	[[ -z "$ssh_host" ]] && ssh_host="$_default_host"
	[[ -z "$ssh_host" ]] && ssh_host="N/A"

	printf "%bðŸ”Œ SSH Port:%b [%s] " "$(c ui_label)" "$(reset)" "$_default_port"
	read -r ssh_port
	[[ -z "$ssh_port" ]] && ssh_port="$_default_port"
	if ! _is_int "$ssh_port" || [[ "$ssh_port" -lt 1 || "$ssh_port" -gt 65535 ]]; then
		msg_err "Invalid port."
		sleep 1
		clear
		continue
	fi

	# Expiration + limit
	printf "%bâ³ Expiration (days):%b [%s] " "$(c ui_label)" "$(reset)" "$_default_days"
	read -r dias
	[[ -z "$dias" ]] && dias="$_default_days"
	if ! _is_int "$dias" || [[ "$dias" -lt 1 ]]; then
		msg_err "Expiration days must be a positive number."
		sleep 1
		clear
		continue
	fi

	printf "%bðŸ”— Connection limit:%b [%s] " "$(c ui_label)" "$(reset)" "$_default_limit"
	read -r sshlimiter
	[[ -z "$sshlimiter" ]] && sshlimiter="$_default_limit"
	if ! _is_int "$sshlimiter" || [[ "$sshlimiter" -lt 1 ]]; then
		msg_err "Connection limit must be a positive number."
		sleep 1
		clear
		continue
	fi

	# Advanced options (optional)
	sni=""
	udpgwPort="7300"
	dnsTTMode="UDP"
	tlsVersion="DEFAULT"
	printf "\n%bAdvanced options:%b [Enter] skip   [a] edit advanced\n" "$(c ui_label)" "$(reset)"
	read -r adv
	if [[ "${adv:-}" =~ ^[Aa]$ ]]; then
		title_line "ADVANCED OPTIONS"
		printf "%bSNI:%b [%s] " "$(c ui_label)" "$(reset)" ""
		read -r sni
		printf "%bUDP GW Port:%b [%s] " "$(c ui_label)" "$(reset)" "$udpgwPort"
		read -r _p
		[[ -n "$_p" ]] && udpgwPort="$_p"
		printf "%bDNS mode (UDP/TCP/DOH):%b [%s] " "$(c ui_label)" "$(reset)" "$dnsTTMode"
		read -r _d
		[[ -n "$_d" ]] && dnsTTMode="$_d"
		printf "%bTLS version:%b [%s] " "$(c ui_label)" "$(reset)" "$tlsVersion"
		read -r _t
		[[ -n "$_t" ]] && tlsVersion="$_t"
	fi

	# Confirm summary
	final=$(date "+%Y-%m-%d" -d "+$dias days" 2>/dev/null)
	gui=$(date "+%d/%m/%Y" -d "+$dias days" 2>/dev/null)
	[[ -z "$final" ]] && final="never"
	[[ -z "$gui" ]] && gui="$final"

	hr
	printf "%bProceed? [Y/n]:%b " "$(c ui_prompt)" "$(reset)"
	read -r proceed
	[[ -z "$proceed" ]] && proceed="Y"
	if [[ "$proceed" =~ ^[Nn]$ ]]; then
		exit 0
	fi

	break
done

# Create system user, then set password through the service (no `passwd` usage)
useradd -e "$final" -M -s /bin/false "$username" >/dev/null 2>&1 || {
	echo ""
	msg_err "Failed to create user $username"
	echo ""
	exit 1
}
if ! sshplus_set_system_password "$username" "$password"; then
	# Keep DB/system consistent: if password set fails, delete the user and stop
	userdel -f "$username" >/dev/null 2>&1 || true
	echo ""
	msg_err "Failed to set password for $username"
	echo ""
	exit 1
fi

# Record in centralized DB (single source of truth)
sshplus_with_db_lock sshplus_db_put_user \
	"$username" \
	"$sshlimiter" \
	"$final" \
	"$(sshplus_now_date)" \
	0 \
	0 \
	"never" \
	"$(sshplus_hash_password "$password")" || true

# Build JSON + link (must show on result page)
config_json="$(_build_npvt_json "$remarks" "$ssh_host" "$ssh_port" "$username" "$password" "$sni" "$tlsVersion" "$dnsTTMode" "$udpgwPort")"
import_link="$(_npvt_link_from_json "$config_json" 2>/dev/null || true)"

# Result screen (copy-friendly)
clear
title_line "SSH ACCOUNT CREATED"
echo ""
_print_kv_aligned "ðŸŒ Host:" "$ssh_host"
_print_kv_aligned "ðŸ”Œ Port:" "$ssh_port"
_print_kv_aligned "ðŸ‘¤ Username:" "$username"
_print_kv_aligned "ðŸ”’ Password:" "$password"
_print_kv_aligned "ðŸ· Remark:" "$remarks"
_print_kv_aligned "â³ Expires in:" "${gui} (${dias}d)"
_print_kv_aligned "ðŸ”— Conn limit:" "$sshlimiter"

echo ""
printf "%bImport link:%b\n" "$(c ui_label)" "$(reset)"
if [[ -n "${import_link:-}" ]]; then
	printf "%s\n" "$import_link"
else
	msg_warn "Could not generate import link (missing base64/openssl)."
fi

echo ""
printf "%bConfig JSON:%b\n" "$(c ui_label)" "$(reset)"
printf "%s\n" "$config_json"

if [[ -e /etc/openvpn/server.conf ]]; then
	printf "\n%bðŸ“¦ Generate OpenVPN file now? [y/N]:%b " "$(c ui_prompt)" "$(reset)"
	read -r _gen_ovpn || _gen_ovpn=""
	[[ -z "$_gen_ovpn" ]] && _gen_ovpn="N"
	if [[ "$_gen_ovpn" =~ ^[Yy]$ ]]; then
		printf "%bEmbedding username/password in .ovpn? [y/N]:%b " "$(c ui_prompt)" "$(reset)"
		read -r _embed || _embed=""
		[[ -z "$_embed" ]] && _embed="N"

		# Build client cert and generate client file
		if [[ -d /etc/openvpn/easy-rsa ]]; then
			(
				cd /etc/openvpn/easy-rsa/ || exit 1
				./easyrsa build-client-full "$username" nopass
			) >/dev/null 2>&1 || msg_warn "OpenVPN client cert generation failed."
		fi
		newclient "$username" >/dev/null 2>&1 || msg_warn "OpenVPN profile generation failed."

		if [[ "$_embed" =~ ^[Yy]$ ]] && [[ -f "/root/${username}.ovpn" ]]; then
			sed -e "s;auth-user-pass;<auth-user-pass>\n${username}\n${password}\n</auth-user-pass>;g" "/root/${username}.ovpn" >"/root/tmp.ovpn" 2>/dev/null && mv -f "/root/tmp.ovpn" "/root/${username}.ovpn"
		fi

		if command -v zip >/dev/null 2>&1 && [[ -f "/root/${username}.ovpn" ]]; then
			rm -f "/root/${username}.zip" 2>/dev/null || true
			zip -j "/root/${username}.zip" "/root/${username}.ovpn" >/dev/null 2>&1 || true
			if [[ -d /var/www/html/openvpn ]]; then
				mv -f "/root/${username}.zip" "/var/www/html/openvpn/${username}.zip" >/dev/null 2>&1 || true
				msg_ok "OpenVPN file: /var/www/html/openvpn/${username}.zip"
			else
				msg_ok "OpenVPN file: /root/${username}.zip"
			fi
		else
			msg_warn "zip not found or .ovpn missing; OpenVPN bundle not created."
		fi
	fi
fi

hr
printf "%bPress Enter to return to menuâ€¦%b" "$(c ui_prompt)" "$(reset)"
read -r _
exit 0
[[ -e /etc/openvpn/server.conf ]] && {
	color_echo_n "Generate Ovpn File " "green"
	color_echo_n "? " "red"
	color_echo_n "[y/n]: " "yellow"
	read -r resp
	[[ "$resp" = @(y|Y) ]] && {
		rm $username.zip $username.ovpn >/dev/null 2>&1
		color_echo_n "Generate with username and password " "green"
		color_echo_n "? " "red"
		color_echo_n "[y/n]: " "yellow"
		read respost
		color_echo_n "Current Host" "green"
		color_echo_n ": " "white"
		color_echo_n "(" "red"
		color_echo_n "$Host" "white"
		color_echo_n ") " "red"
		color_echo_n "- " "white"
		color_echo_n "Change " "green"
		color_echo_n "? " "red"
		color_echo_n "[y/n]: " "yellow"
		read -r oprc
		[[ "$oprc" = @(y|Y) ]] && {
			fun_edithost
		} || {
			fun_geraovpn
		}
		gerarovpn() {
			[[ ! -e "/root/$username.zip" ]] && {
				zip /root/$username.zip /root/$username.ovpn
				sleep 1.5
			}
		}
		clear
		banner_info "       SSH ACCOUNT CREATED !      "
		# Use color functions for account info display
		echo ""
		# Ensure IP is set
		if [[ -z "$IP" ]] || [[ "$IP" == "" ]]; then
			if [[ -f /etc/IP ]] && [[ -s /etc/IP ]]; then
				IP=$(cat /etc/IP)
			else
				IP=$(hostname -I | awk '{print $1}' 2>/dev/null)
				[[ -z "$IP" ]] && IP=$(wget -qO- ipv4.icanhazip.com 2>/dev/null)
				[[ -z "$IP" ]] && IP=$(curl -s ipv4.icanhazip.com 2>/dev/null)
				[[ -z "$IP" ]] && IP="N/A"
			fi
		fi
		color_echo_n "IP: " "green"
		color_echo "$IP" "white"
		color_echo_n "User: " "green"
		color_echo "$username" "white"
		color_echo_n "Password: " "green"
		color_echo "$password" "white"
		color_echo_n "Expires in: " "green"
		color_echo "$gui" "white"
		color_echo_n "Connection limit: " "green"
		color_echo "$sshlimiter" "white"
		# Generate and display npvt-ssh:// import link
		_ssh_port=$(_get_ssh_port)
		_import_link=$(_generate_npvt_link "$username" "$password" "$IP" "$_ssh_port")
		if [[ -n "$_import_link" ]]; then
			echo ""
			color_echo_n "Import link: " "green"
			color_echo "$_import_link" "cyan"
		fi
		sleep 1
		function aguarde() {
			helice() {
				gerarovpn >/dev/null 2>&1 &
				tput civis
				while [ -d /proc/$! ]; do
					for i in / - \\ \|; do
						sleep .1
						echo -ne "\e[1D$i"
					done
				done
				tput cnorm
			}
			echo ""
			color_echo_n "CREATING OVPN" "red"
			color_echo_n "." "yellow"
			color_echo_n ". " "red"
			color_echo_n "" "green"
			helice
			echo -e "\e[1DOK"
		}
		aguarde
		VERSION_ID=$(cat /etc/os-release | grep "VERSION_ID")
		echo ""
		[[ -d /var/www/html/openvpn ]] && {
			mv $HOME/$username.zip /var/www/html/openvpn/$username.zip >/dev/null 2>&1
			[[ "$VERSION_ID" = 'VERSION_ID="14.04"' ]] && {
				color_echo_n "LINK: " "green"
			color_echo "$IP:81/html/openvpn/$username.zip" "cyan"
			} || {
				color_echo_n "LINK: " "green"
				color_echo "$IP:81/openvpn/$username.zip" "cyan"
			}
		} || {
			color_echo_n "Available in" "green"
			color_echo " ~/$username.zip" "red"
			sleep 1
		}
	} || {
		clear
		banner_info "       SSH ACCOUNT CREATED !      "
		# Use color functions for account info display
		echo ""
		# Ensure IP is set
		if [[ -z "$IP" ]] || [[ "$IP" == "" ]]; then
			if [[ -f /etc/IP ]] && [[ -s /etc/IP ]]; then
				IP=$(cat /etc/IP)
			else
				IP=$(hostname -I | awk '{print $1}' 2>/dev/null)
				[[ -z "$IP" ]] && IP=$(wget -qO- ipv4.icanhazip.com 2>/dev/null)
				[[ -z "$IP" ]] && IP=$(curl -s ipv4.icanhazip.com 2>/dev/null)
				[[ -z "$IP" ]] && IP="N/A"
			fi
		fi
		color_echo_n "IP: " "green"
		color_echo "$IP" "white"
		color_echo_n "User: " "green"
		color_echo "$username" "white"
		color_echo_n "Password: " "green"
		color_echo "$password" "white"
		color_echo_n "Expires in: " "green"
		color_echo "$gui" "white"
		color_echo_n "Connection limit: " "green"
		color_echo "$sshlimiter" "white"
		# Generate and display npvt-ssh:// import link
		_ssh_port=$(_get_ssh_port)
		_import_link=$(_generate_npvt_link "$username" "$password" "$IP" "$_ssh_port")
		if [[ -n "$_import_link" ]]; then
			echo ""
			color_echo_n "Import link: " "green"
			color_echo "$_import_link" "cyan"
		fi
	}
} || {
	clear
	banner_info "       SSH ACCOUNT CREATED !      "
	# Use color functions for account info display
	echo ""
	# Ensure IP is set (same fallback as other branches)
	if [[ -z "$IP" ]]; then
		if [[ -f /etc/IP ]] && [[ -s /etc/IP ]]; then
			IP=$(cat /etc/IP)
		else
			IP=$(hostname -I 2>/dev/null | awk '{print $1}')
			[[ -z "$IP" ]] && IP=$(wget -qO- ipv4.icanhazip.com 2>/dev/null)
			[[ -z "$IP" ]] && IP=$(curl -s ipv4.icanhazip.com 2>/dev/null)
			[[ -n "$IP" ]] && echo "$IP" > /etc/IP 2>/dev/null
			[[ -z "$IP" ]] && IP="N/A"
		fi
	fi
	color_echo_n "IP: " "green"
	color_echo "$IP" "white"
	color_echo_n "User: " "green"
	color_echo "$username" "white"
	color_echo_n "Password: " "green"
	color_echo "$password" "white"
	color_echo_n "Expires in: " "green"
	color_echo "$gui" "white"
	color_echo_n "Connection limit: " "green"
	color_echo "$sshlimiter" "white"
	# Generate and display npvt-ssh:// import link
	_ssh_port=$(_get_ssh_port)
	_import_link=$(_generate_npvt_link "$username" "$password" "$IP" "$_ssh_port")
	if [[ -n "$_import_link" ]]; then
		echo ""
		color_echo_n "Import link: " "green"
		color_echo "$_import_link" "cyan"
	fi
}
