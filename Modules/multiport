#!/bin/bash

# SSH Multi-Port Setup Module
# Configures SSH to listen on multiple ports using systemd socket activation

# Load color utility functions
if [[ -f "/etc/SSHPlus/colors" ]]; then
    source /etc/SSHPlus/colors
elif [[ -f "/bin/colors" ]]; then
    source /bin/colors
elif [[ -f "$(dirname "$0")/colors" ]]; then
    source "$(dirname "$0")/colors"
fi

# Function to check and install dependencies
check_dependencies() {
    local missing_deps=()
    local install_needed=false
    local needs_root=false
    
    # Check for package manager
    local pkg_manager=""
    if command -v apt-get > /dev/null 2>&1; then
        pkg_manager="apt-get"
    elif command -v yum > /dev/null 2>&1; then
        pkg_manager="yum"
    elif command -v dnf > /dev/null 2>&1; then
        pkg_manager="dnf"
    elif command -v pacman > /dev/null 2>&1; then
        pkg_manager="pacman"
    fi
    
    info_msg "Checking dependencies..."
    
    # Check for openssh-server
    if ! command -v sshd > /dev/null 2>&1; then
        missing_deps+=("openssh-server")
        install_needed=true
        needs_root=true
    fi
    
    # Check for ss (from iproute2)
    if ! command -v ss > /dev/null 2>&1; then
        missing_deps+=("iproute2")
        install_needed=true
        needs_root=true
    fi
    
    # Check for systemctl (from systemd) - optional but recommended
    if ! command -v systemctl > /dev/null 2>&1; then
        warning_msg "systemd not found. Some features may not work."
    fi
    
    # Check for ufw - optional
    if ! command -v ufw > /dev/null 2>&1; then
        info_msg "UFW not installed (optional - firewall configuration will be skipped)"
    fi
    
    # Check for essential text processing tools
    for tool in grep sed awk cut; do
        if ! command -v "$tool" > /dev/null 2>&1; then
            missing_deps+=("$tool")
            install_needed=true
            needs_root=true
        fi
    done
    
    # If installation is needed, check for root access
    if [[ $needs_root == true ]]; then
        if [[ $EUID -ne 0 ]]; then
            error_msg "Missing dependencies detected. This script must be run as root to install them."
            error_msg "Missing: ${missing_deps[*]}"
            error_msg "Please run: sudo $0"
            return 1
        fi
        
        if [[ -z "$pkg_manager" ]]; then
            error_msg "No supported package manager found. Please install dependencies manually:"
            error_msg "Missing: ${missing_deps[*]}"
            return 1
        fi
    fi
    
    # Check for package manager
    local pkg_manager=""
    if command -v apt-get > /dev/null 2>&1; then
        pkg_manager="apt-get"
    elif command -v yum > /dev/null 2>&1; then
        pkg_manager="yum"
    elif command -v dnf > /dev/null 2>&1; then
        pkg_manager="dnf"
    elif command -v pacman > /dev/null 2>&1; then
        pkg_manager="pacman"
    else
        warning_msg "No supported package manager found. Please install dependencies manually."
        return 1
    fi
    
    info_msg "Checking dependencies..."
    
    # Check for openssh-server
    if ! command -v sshd > /dev/null 2>&1; then
        missing_deps+=("openssh-server")
        install_needed=true
    fi
    
    # Check for ss (from iproute2)
    if ! command -v ss > /dev/null 2>&1; then
        missing_deps+=("iproute2")
        install_needed=true
    fi
    
    # Check for systemctl (from systemd) - optional but recommended
    if ! command -v systemctl > /dev/null 2>&1; then
        warning_msg "systemd not found. Some features may not work."
    fi
    
    # Check for ufw - optional
    if ! command -v ufw > /dev/null 2>&1; then
        info_msg "UFW not installed (optional - firewall configuration will be skipped)"
    fi
    
    # Check for essential text processing tools
    for tool in grep sed awk cut; do
        if ! command -v "$tool" > /dev/null 2>&1; then
            missing_deps+=("$tool")
            install_needed=true
        fi
    done
    
    # Install missing dependencies if needed
    if [[ $install_needed == true ]]; then
        info_msg "Installing missing dependencies: ${missing_deps[*]}"
        
        case "$pkg_manager" in
            apt-get)
                apt-get update -qq > /dev/null 2>&1
                for dep in "${missing_deps[@]}"; do
                    if [[ "$dep" == "openssh-server" ]]; then
                        apt-get install -y openssh-server > /dev/null 2>&1
                    elif [[ "$dep" == "iproute2" ]]; then
                        apt-get install -y iproute2 > /dev/null 2>&1
                    elif [[ "$dep" == "grep" ]]; then
                        apt-get install -y grep > /dev/null 2>&1
                    elif [[ "$dep" == "sed" ]]; then
                        apt-get install -y sed > /dev/null 2>&1
                    elif [[ "$dep" == "awk" ]]; then
                        apt-get install -y gawk > /dev/null 2>&1
                    elif [[ "$dep" == "cut" ]]; then
                        apt-get install -y coreutils > /dev/null 2>&1
                    fi
                done
                ;;
            yum)
                for dep in "${missing_deps[@]}"; do
                    if [[ "$dep" == "openssh-server" ]]; then
                        yum install -y openssh-server > /dev/null 2>&1
                    elif [[ "$dep" == "iproute2" ]]; then
                        yum install -y iproute > /dev/null 2>&1
                    elif [[ "$dep" == "grep" ]]; then
                        yum install -y grep > /dev/null 2>&1
                    elif [[ "$dep" == "sed" ]]; then
                        yum install -y sed > /dev/null 2>&1
                    elif [[ "$dep" == "awk" ]]; then
                        yum install -y gawk > /dev/null 2>&1
                    elif [[ "$dep" == "cut" ]]; then
                        yum install -y coreutils > /dev/null 2>&1
                    fi
                done
                ;;
            dnf)
                for dep in "${missing_deps[@]}"; do
                    if [[ "$dep" == "openssh-server" ]]; then
                        dnf install -y openssh-server > /dev/null 2>&1
                    elif [[ "$dep" == "iproute2" ]]; then
                        dnf install -y iproute > /dev/null 2>&1
                    elif [[ "$dep" == "grep" ]]; then
                        dnf install -y grep > /dev/null 2>&1
                    elif [[ "$dep" == "sed" ]]; then
                        dnf install -y sed > /dev/null 2>&1
                    elif [[ "$dep" == "awk" ]]; then
                        dnf install -y gawk > /dev/null 2>&1
                    elif [[ "$dep" == "cut" ]]; then
                        dnf install -y coreutils > /dev/null 2>&1
                    fi
                done
                ;;
            pacman)
                for dep in "${missing_deps[@]}"; do
                    if [[ "$dep" == "openssh-server" ]]; then
                        pacman -S --noconfirm openssh > /dev/null 2>&1
                    elif [[ "$dep" == "iproute2" ]]; then
                        pacman -S --noconfirm iproute2 > /dev/null 2>&1
                    elif [[ "$dep" == "grep" ]]; then
                        pacman -S --noconfirm grep > /dev/null 2>&1
                    elif [[ "$dep" == "sed" ]]; then
                        pacman -S --noconfirm sed > /dev/null 2>&1
                    elif [[ "$dep" == "awk" ]]; then
                        pacman -S --noconfirm gawk > /dev/null 2>&1
                    elif [[ "$dep" == "cut" ]]; then
                        pacman -S --noconfirm coreutils > /dev/null 2>&1
                    fi
                done
                ;;
        esac
        
        # Verify installations
        local failed=()
        for dep in "${missing_deps[@]}"; do
            local cmd=""
            case "$dep" in
                openssh-server) cmd="sshd" ;;
                iproute2) cmd="ss" ;;
                grep) cmd="grep" ;;
                sed) cmd="sed" ;;
                awk) cmd="awk" ;;
                cut) cmd="cut" ;;
            esac
            
            if [[ -n "$cmd" ]] && ! command -v "$cmd" > /dev/null 2>&1; then
                failed+=("$dep")
            fi
        done
        
        if [[ ${#failed[@]} -gt 0 ]]; then
            error_msg "Failed to install: ${failed[*]}"
            error_msg "Please install them manually and try again."
            return 1
        else
            success_msg "All dependencies installed successfully!"
        fi
    else
        success_msg "All dependencies are installed."
    fi
    
    # Verify sshd_config exists
    if [[ ! -f "/etc/ssh/sshd_config" ]]; then
        error_msg "SSH configuration file not found: /etc/ssh/sshd_config"
        error_msg "Please ensure OpenSSH server is properly installed."
        return 1
    fi
    
    return 0
}

# Function to verify port is valid
verif_ptrs() {
    local port=$1
    if [[ ! "$port" =~ ^[0-9]+$ ]] || [[ "$port" -lt 1 ]] || [[ "$port" -gt 65535 ]]; then
        echo ""
        error_msg "Invalid port number! Port must be between 1 and 65535."
        return 1
    fi
    return 0
}

# Function to check if systemd is available
check_systemd() {
    if ! command -v systemctl > /dev/null 2>&1; then
        error_msg "systemd is not available on this system!"
        return 1
    fi
    return 0
}

# Function to ensure required SSH directories exist
ensure_ssh_directories() {
    # Check if privilege separation is disabled in sshd_config
    if grep -qE "^[[:space:]]*UsePrivilegeSeparation[[:space:]]+no" /etc/ssh/sshd_config 2>/dev/null; then
        # Privilege separation is disabled, directory not needed
        return 0
    fi
    
    # Try to create /run/sshd first (most common location)
    if [[ ! -d "/run/sshd" ]]; then
        if mkdir -p /run/sshd 2>/dev/null; then
            chmod 0755 /run/sshd 2>/dev/null
            chown root:root /run/sshd 2>/dev/null || true
        else
            # If /run/sshd fails, try /var/run/sshd
            if [[ ! -d "/var/run/sshd" ]]; then
                if mkdir -p /var/run/sshd 2>/dev/null; then
                    chmod 0755 /var/run/sshd 2>/dev/null
                    chown root:root /var/run/sshd 2>/dev/null || true
                fi
            fi
            
            # If still can't create, check if we can configure sshd_config to use different location
            if [[ ! -d "/run/sshd" ]] && [[ ! -d "/var/run/sshd" ]]; then
                # Check if PrivilegeSeparationDirectory is set in config
                if ! grep -qE "^[[:space:]]*PrivilegeSeparationDirectory" /etc/ssh/sshd_config 2>/dev/null; then
                    # Try to add it pointing to /var/run/sshd if that exists
                    if [[ -d "/var/run" ]]; then
                        if mkdir -p /var/run/sshd 2>/dev/null; then
                            chmod 0755 /var/run/sshd 2>/dev/null
                            # Add configuration to use this directory
                            if ! grep -q "PrivilegeSeparationDirectory" /etc/ssh/sshd_config 2>/dev/null; then
                                echo "PrivilegeSeparationDirectory /var/run/sshd" >> /etc/ssh/sshd_config 2>/dev/null || true
                            fi
                        fi
                    fi
                fi
            fi
        fi
    fi
    
    # Final verification - check if directory exists or privilege separation is disabled
    if [[ ! -d "/run/sshd" ]] && [[ ! -d "/var/run/sshd" ]]; then
        # Check if privilege separation directory is configured in sshd_config
        local priv_sep_dir=$(grep -E "^[[:space:]]*PrivilegeSeparationDirectory" /etc/ssh/sshd_config 2>/dev/null | awk '{print $2}' | head -1)
        if [[ -n "$priv_sep_dir" ]] && [[ -d "$priv_sep_dir" ]]; then
            return 0
        fi
        
        # Last resort: disable privilege separation if directory can't be created
        if ! grep -qE "^[[:space:]]*UsePrivilegeSeparation" /etc/ssh/sshd_config 2>/dev/null; then
            echo "UsePrivilegeSeparation no" >> /etc/ssh/sshd_config 2>/dev/null || true
            return 0
        fi
        
        return 1
    fi
    
    return 0
}

# Function to get current SSH ports from sshd_config
get_current_ports() {
    # Get all Port lines (including those with leading spaces)
    grep -E '^[[:space:]]*Port[[:space:]]+' /etc/ssh/sshd_config 2>/dev/null | awk '{print $2}' | sort -n | uniq
}

# Function to check if a specific port exists in sshd_config
port_exists() {
    local port=$1
    # Check if port exists (handles spaces and exact match)
    grep -qE "^[[:space:]]*Port[[:space:]]+${port}[[:space:]]*$" /etc/ssh/sshd_config 2>/dev/null
}

# Function to show current ports
show_current_ports() {
    local ports=$(get_current_ports)
    if [[ -z "$ports" ]]; then
        color_echo "No ports configured (using default port 22)" "yellow"
    else
        color_echo "Current SSH ports:" "green"
        echo "$ports" | while read port; do
            color_echo "  - Port $port" "white"
        done
    fi
}

# Function to add port to sshd_config
add_port_sshd() {
    local port=$1
    local quiet="${2:-false}"  # Optional second parameter for quiet mode
    
    # Check if port already exists using the helper function
    if port_exists "$port"; then
        if [[ "$quiet" != "true" ]]; then
            warning_msg "Port $port is already in sshd_config"
        fi
        return 0
    fi
    
    # Add port before any Match blocks (insert only before the first Match)
    if grep -q "^Match" /etc/ssh/sshd_config 2>/dev/null; then
        # Find the first Match line and insert before it (only once)
        local first_match_line=$(grep -n "^Match" /etc/ssh/sshd_config 2>/dev/null | head -1 | cut -d: -f1)
        if [[ -n "$first_match_line" ]]; then
            sed -i "${first_match_line}i\Port $port" /etc/ssh/sshd_config
        else
            # Fallback: add at the end
            echo "Port $port" >> /etc/ssh/sshd_config
        fi
    else
        # Add at the end
        echo "Port $port" >> /etc/ssh/sshd_config
    fi
    
    # Ensure required SSH directories exist before validation
    if ! ensure_ssh_directories; then
        if [[ "$quiet" != "true" ]]; then
            error_msg "Failed to create required SSH directories. Please run as root or create /run/sshd manually."
        fi
        # Still try to validate - sometimes sshd can work without the directory
    fi
    
    # Validate configuration immediately after adding
    local validation_output=$(sshd -t 2>&1)
    if [[ $? -ne 0 ]]; then
        # Revert the change - be more specific with sed pattern
        sed -i "/^[[:space:]]*Port[[:space:]]\+${port}[[:space:]]*$/d" /etc/ssh/sshd_config
        if [[ "$quiet" != "true" ]]; then
            error_msg "Invalid SSH configuration! Port $port not added."
            echo "$validation_output" | head -3 | while read line; do
                color_echo "  $line" "red"
            done
        fi
        return 1
    fi
    
    return 0
}

# Function to remove port from sshd_config
remove_port_sshd() {
    local port=$1
    
    if [[ "$port" == "22" ]]; then
        warning_msg "Cannot remove default port 22!"
        return 1
    fi
    
    if ! grep -q "^Port $port" /etc/ssh/sshd_config 2>/dev/null; then
        error_msg "Port $port is not configured in sshd_config"
        return 1
    fi
    
    sed -i "/^Port $port$/d" /etc/ssh/sshd_config
    
    # Validate configuration
    if ! sshd -t > /dev/null 2>&1; then
        error_msg "Invalid SSH configuration! Reverting changes..."
        # Restore port
        add_port_sshd "$port"
        return 1
    fi
    
    return 0
}

# Function to configure systemd socket
configure_systemd_socket() {
    local ports=$(get_current_ports)
    
    # Create override directory
    mkdir -p /etc/systemd/system/ssh.socket.d
    
    # Create socket override file
    cat > /etc/systemd/system/ssh.socket.d/override.conf << 'EOF'
[Socket]
ListenStream=
EOF
    
    # Add all ports to socket configuration
    while read port; do
        echo "ListenStream=0.0.0.0:$port" >> /etc/systemd/system/ssh.socket.d/override.conf
        echo "ListenStream=[::]:$port" >> /etc/systemd/system/ssh.socket.d/override.conf
    done <<< "$ports"
    
    # Reload systemd
    systemctl daemon-reload
    
    # Restart socket
    systemctl restart ssh.socket
    
    # Restart service
    systemctl restart ssh.service
}

# Function to configure UFW firewall
configure_ufw() {
    local ports=$(get_current_ports)
    
    if ! command -v ufw > /dev/null 2>&1; then
        warning_msg "UFW is not installed. Skipping firewall configuration."
        return 0
    fi
    
    # Enable UFW if not already enabled
    if ! ufw status | grep -q "Status: active"; then
        info_msg "Enabling UFW..."
        ufw --force enable > /dev/null 2>&1
    fi
    
    # Allow all configured ports
    while read port; do
        ufw allow "$port/tcp" > /dev/null 2>&1
    done <<< "$ports"
    
    success_msg "UFW firewall rules updated"
}

# Function to verify setup
verify_setup() {
    echo ""
    color_echo "Verifying SSH multi-port setup..." "green"
    echo ""
    
    # Check listening ports
    local listening=$(ss -ltnp 2>/dev/null | grep ssh | awk '{print $4}' | cut -d: -f2 | sort -n | uniq)
    if [[ -n "$listening" ]]; then
        color_echo "SSH is listening on ports:" "green"
        echo "$listening" | while read port; do
            color_echo "  ✓ Port $port" "white"
        done
    else
        warning_msg "No SSH ports found listening!"
    fi
    
    # Check systemd socket status
    if systemctl is-active --quiet ssh.socket; then
        success_msg "systemd ssh.socket is active"
    else
        error_msg "systemd ssh.socket is not active!"
    fi
    
    # Check sshd accepted ports
    local accepted=$(sshd -T 2>/dev/null | grep '^port' | awk '{print $2}' | sort -n | uniq)
    if [[ -n "$accepted" ]]; then
        color_echo "sshd accepts connections on ports:" "green"
        echo "$accepted" | while read port; do
            color_echo "  ✓ Port $port" "white"
        done
    fi
}

# Main menu
main_menu() {
    while true; do
        clear
        print_header "         SSH MULTI-PORT SETUP          "
        echo ""
        show_current_ports
        echo ""
        menu_option "1" "ADD PORT" "red" "yellow"
        menu_option "2" "REMOVE PORT" "red" "yellow"
        menu_option "3" "SETUP MULTIPLE PORTS (QUICK)" "red" "yellow"
        menu_option "4" "VERIFY SETUP" "red" "yellow"
        menu_option "5" "BACK" "red" "yellow"
        echo ""
        color_echo_n "SELECT OPTION: " "green"
        read -r option
        
        case "$option" in
            1)
                clear
                print_header "         ADD PORT TO SSH          "
                echo ""
                color_echo_n "Enter port number: " "green"
                read -r port
                
                if [[ -z "$port" ]]; then
                    error_msg "Port cannot be empty!"
                    sleep 2
                    continue
                fi
                
                if ! verif_ptrs "$port"; then
                    sleep 2
                    continue
                fi
                
                # Ensure required SSH directories exist
                ensure_ssh_directories
                
                if add_port_sshd "$port"; then
                    if check_systemd; then
                        configure_systemd_socket
                    else
                        if command -v systemctl > /dev/null 2>&1; then
                            systemctl restart ssh.service 2>/dev/null || systemctl restart sshd.service 2>/dev/null
                        else
                            service ssh restart 2>/dev/null || service sshd restart 2>/dev/null
                        fi
                    fi
                    configure_ufw
                    success_msg "Port $port added successfully!"
                else
                    error_msg "Failed to add port $port!"
                fi
                
                sleep 3
                ;;
            2)
                clear
                print_header_red "       REMOVE PORT FROM SSH        "
                echo ""
                show_current_ports
                echo ""
                warning_msg "Cannot remove default port 22!"
                echo ""
                color_echo_n "Enter port number to remove: " "green"
                read -r port
                
                if [[ -z "$port" ]]; then
                    error_msg "Port cannot be empty!"
                    sleep 2
                    continue
                fi
                
                if [[ "$port" == "22" ]]; then
                    error_msg "Cannot remove default port 22!"
                    sleep 2
                    continue
                fi
                
                echo ""
                color_echo "Removing port $port from SSH configuration..." "green"
                echo ""
                
                if remove_port_sshd "$port"; then
                    if check_systemd; then
                        configure_systemd_socket
                    else
                        # Fallback: restart SSH service
                        if command -v systemctl > /dev/null 2>&1; then
                            systemctl restart ssh.service 2>/dev/null || systemctl restart sshd.service 2>/dev/null
                        else
                            service ssh restart 2>/dev/null || service sshd restart 2>/dev/null
                        fi
                    fi
                    
                    success_msg "Port $port removed successfully!"
                else
                    error_msg "Failed to remove port $port!"
                fi
                
                sleep 3
                ;;
            3)
                clear
                print_header "      QUICK MULTI-PORT SETUP       "
                echo ""
                color_echo "Enter ports separated by comma:" "yellow"
                color_echo "Example: 22, 3398, 443, 80, 8080" "white"
                echo ""
                color_echo_n "Ports: " "green"
                read -r ports_input
                
                if [[ -z "$ports_input" ]]; then
                    error_msg "No ports entered!"
                    sleep 2
                    continue
                fi
                
                # Ensure required SSH directories exist
                if ! ensure_ssh_directories; then
                    error_msg "Warning: Could not create /run/sshd directory."
                    error_msg "Please create it manually: mkdir -p /run/sshd && chmod 0755 /run/sshd"
                    error_msg "Or run this script as root."
                    sleep 3
                    continue
                fi
                
                # Create backup of sshd_config before making changes
                local backup_file="/etc/ssh/sshd_config.backup.$(date +%Y%m%d_%H%M%S)"
                if cp /etc/ssh/sshd_config "$backup_file" 2>/dev/null; then
                    info_msg "Backup created: $backup_file"
                fi
                
                # Validate current config before making changes
                local validation_error=$(sshd -t 2>&1)
                if [[ $? -ne 0 ]]; then
                    error_msg "Current SSH configuration has errors:"
                    echo "$validation_error" | while read line; do
                        color_echo "  $line" "red"
                    done
                    error_msg "Please fix existing configuration errors first!"
                    sleep 3
                    continue
                fi
                
                # Parse comma-separated ports, trim spaces
                local ports_list=""
                IFS=',' read -ra port_array <<< "$ports_input"
                for port in "${port_array[@]}"; do
                    # Trim whitespace using sed
                    port=$(echo "$port" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
                    if [[ -n "$port" ]]; then
                        if verif_ptrs "$port" 2>/dev/null; then
                            ports_list="$ports_list $port"
                        else
                            warning_msg "Skipping invalid port: $port"
                        fi
                    fi
                done
                
                if [[ -z "$ports_list" ]]; then
                    error_msg "No valid ports to configure!"
                    sleep 2
                    continue
                fi
                
                echo ""
                color_echo "Configuring multiple ports..." "green"
                echo ""
                
                # Get current ports before making changes
                local current_ports=$(get_current_ports)
                
                # Add all ports (skip if already exists)
                local added_count=0
                local skipped_count=0
                local failed_count=0
                
                for port in $ports_list; do
                    # Check if port already exists in current configuration
                    if port_exists "$port"; then
                        ((skipped_count++))
                        continue
                    fi
                    
                    # Try to add the port (quiet mode for batch operations)
                    if add_port_sshd "$port" "true"; then
                        ((added_count++))
                        # Update current_ports list to include newly added port
                        current_ports=$(get_current_ports)
                    else
                        ((failed_count++))
                    fi
                done
                
                # Final validation (only if we made changes)
                if [[ $added_count -gt 0 ]]; then
                    validation_error=$(sshd -t 2>&1)
                    if [[ $? -ne 0 ]]; then
                        error_msg "Configuration validation failed after adding ports!"
                        echo "$validation_error" | while read line; do
                            color_echo "  $line" "red"
                        done
                        
                        # Restore from backup
                        if [[ -f "$backup_file" ]]; then
                            warning_msg "Restoring original configuration from backup..."
                            if cp "$backup_file" /etc/ssh/sshd_config 2>/dev/null; then
                                info_msg "Configuration restored successfully"
                            else
                                error_msg "Failed to restore backup! Manual intervention required."
                            fi
                        else
                            error_msg "No backup found! Please check /etc/ssh/sshd_config manually"
                        fi
                        sleep 3
                        continue
                    fi
                elif [[ $skipped_count -gt 0 ]] && [[ $added_count -eq 0 ]]; then
                    # All ports already exist, just validate current config
                    validation_error=$(sshd -t 2>&1)
                    if [[ $? -ne 0 ]]; then
                        error_msg "Current SSH configuration has errors:"
                        echo "$validation_error" | while read line; do
                            color_echo "  $line" "red"
                        done
                        error_msg "Please fix configuration errors manually!"
                        sleep 3
                        continue
                    fi
                fi
                
                # Apply changes if any ports were added
                if [[ $added_count -gt 0 ]]; then
                    if check_systemd; then
                        configure_systemd_socket
                    else
                        if command -v systemctl > /dev/null 2>&1; then
                            systemctl restart ssh.service 2>/dev/null || systemctl restart sshd.service 2>/dev/null
                        else
                            service ssh restart 2>/dev/null || service sshd restart 2>/dev/null
                        fi
                    fi
                    
                    configure_ufw
                    success_msg "Multi-port setup completed!"
                    if [[ $added_count -gt 0 ]]; then
                        info_msg "Added $added_count new port(s)."
                    fi
                    if [[ $skipped_count -gt 0 ]]; then
                        info_msg "Skipped $skipped_count port(s) that were already configured."
                    fi
                    if [[ $failed_count -gt 0 ]]; then
                        warning_msg "$failed_count port(s) could not be added."
                    fi
                    verify_setup
                elif [[ $skipped_count -gt 0 ]]; then
                    info_msg "All ports are already configured."
                    verify_setup
                else
                    warning_msg "No ports were configured."
                fi
                
                sleep 5
                ;;
            4)
                verify_setup
                echo ""
                color_echo_n "Press ENTER to continue..." "yellow"
                read
                ;;
            5)
                return 0
                ;;
            *)
                error_msg "Invalid option!"
                sleep 2
                ;;
        esac
    done
}

# Check dependencies before starting
if ! check_dependencies; then
    error_msg "Dependency check failed. Exiting..."
    exit 1
fi

# Run main menu
main_menu
