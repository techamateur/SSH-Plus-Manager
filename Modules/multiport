#!/bin/bash

# SSH Multi-Port Setup Module
# Configures SSH to listen on multiple ports using systemd socket activation

# Load color utility functions
if [[ -f "/etc/SSHPlus/colors" ]]; then
    source /etc/SSHPlus/colors
elif [[ -f "/bin/colors" ]]; then
    source /bin/colors
elif [[ -f "$(dirname "$0")/colors" ]]; then
    source "$(dirname "$0")/colors"
fi

# Function to verify port is valid
verif_ptrs() {
    local port=$1
    if [[ ! "$port" =~ ^[0-9]+$ ]] || [[ "$port" -lt 1 ]] || [[ "$port" -gt 65535 ]]; then
        echo ""
        error_msg "Invalid port number! Port must be between 1 and 65535."
        return 1
    fi
    return 0
}

# Function to check if systemd is available
check_systemd() {
    if ! command -v systemctl > /dev/null 2>&1; then
        error_msg "systemd is not available on this system!"
        return 1
    fi
    return 0
}

# Function to get current SSH ports from sshd_config
get_current_ports() {
    # Get all Port lines (including those with leading spaces)
    grep -E '^[[:space:]]*Port[[:space:]]+' /etc/ssh/sshd_config 2>/dev/null | awk '{print $2}' | sort -n | uniq
}

# Function to check if a specific port exists in sshd_config
port_exists() {
    local port=$1
    # Check if port exists (handles spaces and exact match)
    grep -qE "^[[:space:]]*Port[[:space:]]+${port}[[:space:]]*$" /etc/ssh/sshd_config 2>/dev/null
}

# Function to show current ports
show_current_ports() {
    local ports=$(get_current_ports)
    if [[ -z "$ports" ]]; then
        color_echo "No ports configured (using default port 22)" "yellow"
    else
        color_echo "Current SSH ports:" "green"
        echo "$ports" | while read port; do
            color_echo "  - Port $port" "white"
        done
    fi
}

# Function to add port to sshd_config
add_port_sshd() {
    local port=$1
    local quiet="${2:-false}"  # Optional second parameter for quiet mode
    
    # Check if port already exists using the helper function
    if port_exists "$port"; then
        if [[ "$quiet" != "true" ]]; then
            warning_msg "Port $port is already in sshd_config"
        fi
        return 0
    fi
    
    # Add port before any Match blocks (insert only before the first Match)
    if grep -q "^Match" /etc/ssh/sshd_config 2>/dev/null; then
        # Find the first Match line and insert before it (only once)
        local first_match_line=$(grep -n "^Match" /etc/ssh/sshd_config 2>/dev/null | head -1 | cut -d: -f1)
        if [[ -n "$first_match_line" ]]; then
            sed -i "${first_match_line}i\Port $port" /etc/ssh/sshd_config
        else
            # Fallback: add at the end
            echo "Port $port" >> /etc/ssh/sshd_config
        fi
    else
        # Add at the end
        echo "Port $port" >> /etc/ssh/sshd_config
    fi
    
    # Validate configuration immediately after adding
    local validation_output=$(sshd -t 2>&1)
    if [[ $? -ne 0 ]]; then
        # Revert the change - be more specific with sed pattern
        sed -i "/^[[:space:]]*Port[[:space:]]\+${port}[[:space:]]*$/d" /etc/ssh/sshd_config
        if [[ "$quiet" != "true" ]]; then
            error_msg "Invalid SSH configuration! Port $port not added."
            echo "$validation_output" | head -3 | while read line; do
                color_echo "  $line" "red"
            done
        fi
        return 1
    fi
    
    return 0
}

# Function to remove port from sshd_config
remove_port_sshd() {
    local port=$1
    
    if [[ "$port" == "22" ]]; then
        warning_msg "Cannot remove default port 22!"
        return 1
    fi
    
    if ! grep -q "^Port $port" /etc/ssh/sshd_config 2>/dev/null; then
        error_msg "Port $port is not configured in sshd_config"
        return 1
    fi
    
    sed -i "/^Port $port$/d" /etc/ssh/sshd_config
    
    # Validate configuration
    if ! sshd -t > /dev/null 2>&1; then
        error_msg "Invalid SSH configuration! Reverting changes..."
        # Restore port
        add_port_sshd "$port"
        return 1
    fi
    
    return 0
}

# Function to configure systemd socket
configure_systemd_socket() {
    local ports=$(get_current_ports)
    
    # Create override directory
    mkdir -p /etc/systemd/system/ssh.socket.d
    
    # Create socket override file
    cat > /etc/systemd/system/ssh.socket.d/override.conf << 'EOF'
[Socket]
ListenStream=
EOF
    
    # Add all ports to socket configuration
    while read port; do
        echo "ListenStream=0.0.0.0:$port" >> /etc/systemd/system/ssh.socket.d/override.conf
        echo "ListenStream=[::]:$port" >> /etc/systemd/system/ssh.socket.d/override.conf
    done <<< "$ports"
    
    # Reload systemd
    systemctl daemon-reload
    
    # Restart socket
    systemctl restart ssh.socket
    
    # Restart service
    systemctl restart ssh.service
}

# Function to configure UFW firewall
configure_ufw() {
    local ports=$(get_current_ports)
    
    if ! command -v ufw > /dev/null 2>&1; then
        warning_msg "UFW is not installed. Skipping firewall configuration."
        return 0
    fi
    
    # Enable UFW if not already enabled
    if ! ufw status | grep -q "Status: active"; then
        info_msg "Enabling UFW..."
        ufw --force enable > /dev/null 2>&1
    fi
    
    # Allow all configured ports
    while read port; do
        ufw allow "$port/tcp" > /dev/null 2>&1
    done <<< "$ports"
    
    success_msg "UFW firewall rules updated"
}

# Function to verify setup
verify_setup() {
    echo ""
    color_echo "Verifying SSH multi-port setup..." "green"
    echo ""
    
    # Check listening ports
    local listening=$(ss -ltnp 2>/dev/null | grep ssh | awk '{print $4}' | cut -d: -f2 | sort -n | uniq)
    if [[ -n "$listening" ]]; then
        color_echo "SSH is listening on ports:" "green"
        echo "$listening" | while read port; do
            color_echo "  ✓ Port $port" "white"
        done
    else
        warning_msg "No SSH ports found listening!"
    fi
    
    # Check systemd socket status
    if systemctl is-active --quiet ssh.socket; then
        success_msg "systemd ssh.socket is active"
    else
        error_msg "systemd ssh.socket is not active!"
    fi
    
    # Check sshd accepted ports
    local accepted=$(sshd -T 2>/dev/null | grep '^port' | awk '{print $2}' | sort -n | uniq)
    if [[ -n "$accepted" ]]; then
        color_echo "sshd accepts connections on ports:" "green"
        echo "$accepted" | while read port; do
            color_echo "  ✓ Port $port" "white"
        done
    fi
}

# Main menu
main_menu() {
    while true; do
        clear
        print_header "         SSH MULTI-PORT SETUP          "
        echo ""
        show_current_ports
        echo ""
        menu_option "1" "ADD PORT" "red" "yellow"
        menu_option "2" "REMOVE PORT" "red" "yellow"
        menu_option "3" "SETUP MULTIPLE PORTS (QUICK)" "red" "yellow"
        menu_option "4" "VERIFY SETUP" "red" "yellow"
        menu_option "5" "BACK" "red" "yellow"
        echo ""
        color_echo_n "SELECT OPTION: " "green"
        read -r option
        
        case "$option" in
            1)
                clear
                print_header "         ADD PORT TO SSH          "
                echo ""
                color_echo_n "Enter port number: " "green"
                read -r port
                
                if [[ -z "$port" ]]; then
                    error_msg "Port cannot be empty!"
                    sleep 2
                    continue
                fi
                
                if ! verif_ptrs "$port"; then
                    sleep 2
                    continue
                fi
                
                if add_port_sshd "$port"; then
                    if check_systemd; then
                        configure_systemd_socket
                    else
                        if command -v systemctl > /dev/null 2>&1; then
                            systemctl restart ssh.service 2>/dev/null || systemctl restart sshd.service 2>/dev/null
                        else
                            service ssh restart 2>/dev/null || service sshd restart 2>/dev/null
                        fi
                    fi
                    configure_ufw
                    success_msg "Port $port added successfully!"
                else
                    error_msg "Failed to add port $port!"
                fi
                
                sleep 3
                ;;
            2)
                clear
                print_header_red "       REMOVE PORT FROM SSH        "
                echo ""
                show_current_ports
                echo ""
                warning_msg "Cannot remove default port 22!"
                echo ""
                color_echo_n "Enter port number to remove: " "green"
                read -r port
                
                if [[ -z "$port" ]]; then
                    error_msg "Port cannot be empty!"
                    sleep 2
                    continue
                fi
                
                if [[ "$port" == "22" ]]; then
                    error_msg "Cannot remove default port 22!"
                    sleep 2
                    continue
                fi
                
                echo ""
                color_echo "Removing port $port from SSH configuration..." "green"
                echo ""
                
                if remove_port_sshd "$port"; then
                    if check_systemd; then
                        configure_systemd_socket
                    else
                        # Fallback: restart SSH service
                        if command -v systemctl > /dev/null 2>&1; then
                            systemctl restart ssh.service 2>/dev/null || systemctl restart sshd.service 2>/dev/null
                        else
                            service ssh restart 2>/dev/null || service sshd restart 2>/dev/null
                        fi
                    fi
                    
                    success_msg "Port $port removed successfully!"
                else
                    error_msg "Failed to remove port $port!"
                fi
                
                sleep 3
                ;;
            3)
                clear
                print_header "      QUICK MULTI-PORT SETUP       "
                echo ""
                color_echo "Enter ports separated by comma:" "yellow"
                color_echo "Example: 22, 3398, 443, 80, 8080" "white"
                echo ""
                color_echo_n "Ports: " "green"
                read -r ports_input
                
                if [[ -z "$ports_input" ]]; then
                    error_msg "No ports entered!"
                    sleep 2
                    continue
                fi
                
                # Create backup of sshd_config before making changes
                local backup_file="/etc/ssh/sshd_config.backup.$(date +%Y%m%d_%H%M%S)"
                if cp /etc/ssh/sshd_config "$backup_file" 2>/dev/null; then
                    info_msg "Backup created: $backup_file"
                fi
                
                # Validate current config before making changes
                local validation_error=$(sshd -t 2>&1)
                if [[ $? -ne 0 ]]; then
                    error_msg "Current SSH configuration has errors:"
                    echo "$validation_error" | while read line; do
                        color_echo "  $line" "red"
                    done
                    error_msg "Please fix existing configuration errors first!"
                    sleep 3
                    continue
                fi
                
                # Parse comma-separated ports, trim spaces
                local ports_list=""
                IFS=',' read -ra port_array <<< "$ports_input"
                for port in "${port_array[@]}"; do
                    # Trim whitespace using sed
                    port=$(echo "$port" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
                    if [[ -n "$port" ]]; then
                        if verif_ptrs "$port" 2>/dev/null; then
                            ports_list="$ports_list $port"
                        else
                            warning_msg "Skipping invalid port: $port"
                        fi
                    fi
                done
                
                if [[ -z "$ports_list" ]]; then
                    error_msg "No valid ports to configure!"
                    sleep 2
                    continue
                fi
                
                echo ""
                color_echo "Configuring multiple ports..." "green"
                echo ""
                
                # Get current ports before making changes
                local current_ports=$(get_current_ports)
                
                # Add all ports (skip if already exists)
                local added_count=0
                local skipped_count=0
                local failed_count=0
                
                for port in $ports_list; do
                    # Check if port already exists in current configuration
                    if port_exists "$port"; then
                        ((skipped_count++))
                        continue
                    fi
                    
                    # Try to add the port (quiet mode for batch operations)
                    if add_port_sshd "$port" "true"; then
                        ((added_count++))
                        # Update current_ports list to include newly added port
                        current_ports=$(get_current_ports)
                    else
                        ((failed_count++))
                    fi
                done
                
                # Final validation (only if we made changes)
                if [[ $added_count -gt 0 ]]; then
                    validation_error=$(sshd -t 2>&1)
                    if [[ $? -ne 0 ]]; then
                        error_msg "Configuration validation failed after adding ports!"
                        echo "$validation_error" | while read line; do
                            color_echo "  $line" "red"
                        done
                        
                        # Restore from backup
                        if [[ -f "$backup_file" ]]; then
                            warning_msg "Restoring original configuration from backup..."
                            if cp "$backup_file" /etc/ssh/sshd_config 2>/dev/null; then
                                info_msg "Configuration restored successfully"
                            else
                                error_msg "Failed to restore backup! Manual intervention required."
                            fi
                        else
                            error_msg "No backup found! Please check /etc/ssh/sshd_config manually"
                        fi
                        sleep 3
                        continue
                    fi
                elif [[ $skipped_count -gt 0 ]] && [[ $added_count -eq 0 ]]; then
                    # All ports already exist, just validate current config
                    validation_error=$(sshd -t 2>&1)
                    if [[ $? -ne 0 ]]; then
                        error_msg "Current SSH configuration has errors:"
                        echo "$validation_error" | while read line; do
                            color_echo "  $line" "red"
                        done
                        error_msg "Please fix configuration errors manually!"
                        sleep 3
                        continue
                    fi
                fi
                
                # Apply changes if any ports were added
                if [[ $added_count -gt 0 ]]; then
                    if check_systemd; then
                        configure_systemd_socket
                    else
                        if command -v systemctl > /dev/null 2>&1; then
                            systemctl restart ssh.service 2>/dev/null || systemctl restart sshd.service 2>/dev/null
                        else
                            service ssh restart 2>/dev/null || service sshd restart 2>/dev/null
                        fi
                    fi
                    
                    configure_ufw
                    success_msg "Multi-port setup completed!"
                    if [[ $added_count -gt 0 ]]; then
                        info_msg "Added $added_count new port(s)."
                    fi
                    if [[ $skipped_count -gt 0 ]]; then
                        info_msg "Skipped $skipped_count port(s) that were already configured."
                    fi
                    if [[ $failed_count -gt 0 ]]; then
                        warning_msg "$failed_count port(s) could not be added."
                    fi
                    verify_setup
                elif [[ $skipped_count -gt 0 ]]; then
                    info_msg "All ports are already configured."
                    verify_setup
                else
                    warning_msg "No ports were configured."
                fi
                
                sleep 5
                ;;
            4)
                verify_setup
                echo ""
                color_echo_n "Press ENTER to continue..." "yellow"
                read
                ;;
            5)
                return 0
                ;;
            *)
                error_msg "Invalid option!"
                sleep 2
                ;;
        esac
    done
}

# Run main menu
main_menu
