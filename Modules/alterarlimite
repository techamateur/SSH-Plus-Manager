#!/bin/bash

# Load color utility functions
# This provides easy-to-use color functions instead of hardcoded ANSI codes
if [[ -f "/etc/SSHPlus/colors" ]]; then
    source /etc/SSHPlus/colors
elif [[ -f "/bin/colors" ]]; then
    source /bin/colors
elif [[ -f "$(dirname "$0")/colors" ]]; then
    source "$(dirname "$0")/colors"
fi

# Display header with colored background
# Use print_header function - handles fallback internally
print_header "   Change limit of simultaneous connections   "
database="/root/users.db"
if [ ! -f "$database" ]; then
	# Use error message function - handles fallback internally
	echo ""
	error_msg "$database file not found"
	echo ""
	exit 1
else
	# Display header - use color function which handles fallback internally
	echo ""
	color_echo "LIST OF USERS AND THEIR LIMITS:" "yellow"
	echo ""
	_userT=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody)
	i=0
	unset _userPass
	while read _user; do
		i=$(expr $i + 1)
		_oP=$i
		[[ $i == [1-9] ]] && i=0$i && oP+=" 0$i"
		if [[ "$(grep -wc "$_user" $database)" != "0" ]]; then
			limit=$(grep -w "$_user" $database |cut -d' ' -f2)
		else
			limit='1'
		fi
		# Use color helper functions to build formatted strings for printf
		# Functions handle fallback internally, so we can call them directly
		red_code=$(get_color_code "red")
		cyan_code=$(get_color_code "cyan")
		white_code=$(get_color_code "white")
		green_code=$(get_color_code "green")
		yellow_code=$(get_color_code "yellow")
		reset_code=$(get_reset_code)
		
		l_user="${red_code}[${cyan_code}$i${red_code}] ${white_code}- ${green_code}$_user${reset_code}"
		lim="${yellow_code}Limit${white_code}: $limit${reset_code}"
        printf '%-65s%s\n' "$l_user" "$lim"
		_userPass+="\n${_oP}:${_user}"
	done <<< "${_userT}"
	echo ""
	num_user=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody | wc -l)
	# Use color functions for prompt - functions handle fallback internally
	color_echo_n "Type or select a user " "green"
	color_echo_n "[" "yellow"
	color_echo_n "1" "cyan"
	color_echo_n "-" "red"
	color_echo_n "$num_user" "cyan"
	color_echo_n "]" "yellow"
	color_echo_n ": " "white"
	read -r option
	usuario=$(echo -e "${_userPass}" | grep -E "\b$option\b" | cut -d: -f2)
    if [[ -z $option ]]; then
		# Use error message function - handles fallback internally
		echo ""
		error_msg "Empty or non-existent user"
		echo ""
		exit
	elif [[ -z $usuario ]]; then
		# Use error message function - handles fallback internally
		echo ""
		error_msg "Empty or non-existent user"
		echo ""
		exit 1
	else
		if cat /etc/passwd |grep -w $usuario > /dev/null; then
			# Use color functions for prompt - functions handle fallback internally
			echo ""
			color_echo_n "New limit for the user " "green"
			color_echo_n "$usuario" "yellow"
			color_echo_n ": " "white"
			read -r sshnum
			if [[ -z $sshnum ]]
			then
				# Use error message function - handles fallback internally
				echo ""
				error_msg "You entered an invalid number!"
				echo ""
				exit 1
			else
				if (echo $sshnum | egrep [^0-9] &> /dev/null)
				then
					# Use error message function - handles fallback internally
					echo ""
					error_msg "You entered an invalid number!"
					echo ""
					exit 1
				else
					if [[ $sshnum -lt 1 ]]
					then
						# Use error message function - handles fallback internally
						echo ""
						error_msg "You must enter a number greater than zero!"
						echo ""
						exit 1
					else
						grep -v ^$usuario[[:space:]] /root/users.db > /tmp/a
						sleep 1
						mv /tmp/a /root/users.db
						echo $usuario $sshnum >> /root/users.db
						# Use success message function - handles fallback internally
						echo ""
						success_msg "Limit applied to user $usuario was $sshnum"
						sleep 2
						exit
					fi
				fi
			fi			
		else
			# Use error message function - handles fallback internally
			echo ""
			error_msg "User $usuario not found"
			echo ""
			exit 1
		fi
	fi
fi