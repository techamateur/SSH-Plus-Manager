#!/bin/bash

# Load color utility functions
if [[ -f "/etc/SSHPlus/colors" ]]; then
    source /etc/SSHPlus/colors
elif [[ -f "/bin/colors" ]]; then
    source /bin/colors
elif [[ -f "$(dirname "$0")/colors" ]]; then
    source "$(dirname "$0")/colors"
fi

IP=$(cat /etc/IP)
if [ ! -d /etc/SSHPlus/userteste ]; then
mkdir /etc/SSHPlus/userteste
fi
tput setaf 7
tput setab 4
tput bold
printf '%30s%s%-15s\n' "Create test user"
tput sgr0
echo ""
# Use color functions directly
[ "$(ls -A /etc/SSHPlus/userteste)" ] && success_msg "Test User Active!" || error_msg "No active tests user!"
echo ""
for testeson in $(ls /etc/SSHPlus/userteste |sort |sed 's/.sh//g')
do
echo "$testeson"
done
echo ""
# Use color functions for prompts
color_echo_n "User name" "green"
color_echo_n ": " "white"
read -r nome
if [[ -z $nome ]]
then
	echo ""
	error_msg "Empty or invalid name."
	echo ""
	exit 1
fi
awk -F : ' { print $1 }' /etc/passwd > /tmp/users 
if grep -Fxq "$nome" /tmp/users
then
	echo ""
	error_msg "This user already exists."
	echo ""
	exit 1
fi
color_echo_n "Password" "green"
color_echo_n ": " "white"
read -r pass
if [[ -z $pass ]]
then
	echo ""
	error_msg "Password empty or invalid."
	echo ""
	exit 1
fi
color_echo_n "Limit" "green"
color_echo_n ": " "white"
read -r limit
if [[ -z $limit ]]
then
	echo ""
	error_msg "Empty or invalid limit."
	echo ""
	exit 1
fi
color_echo_n "Minutes " "green"
color_echo_n "(" "yellow"
color_echo_n "Ex: " "red"
color_echo_n "60" "white"
color_echo_n ")" "yellow"
color_echo_n ": " "white"
read -r u_temp
if [[ -z $u_temp ]]
then
	echo ""
	error_msg "Empty or invalid time."
	echo ""
	exit 1
fi
useradd -M -s /bin/false $nome
(echo $pass;echo $pass) |passwd $nome > /dev/null 2>&1
echo "$pass" > /etc/SSHPlus/senha/$nome
echo "$nome $limit" >> /root/users.db
echo "#!/bin/bash
pkill -f "$nome"
userdel --force $nome
grep -v ^$nome[[:space:]] /root/users.db > /tmp/ph ; cat /tmp/ph > /root/users.db
rm /etc/SSHPlus/senha/$nome > /dev/null 2>&1
rm -rf /etc/SSHPlus/userteste/$nome.sh
exit" > /etc/SSHPlus/userteste/$nome.sh
chmod +x /etc/SSHPlus/userteste/$nome.sh
at -f /etc/SSHPlus/userteste/$nome.sh now + $u_temp min > /dev/null 2>&1
clear
# Use print_header function for colored header
print_header "     Test User Created     "
echo ""
# Use color functions for output
color_echo_n "IP:" "green"
color_echo_n " $IP" "white"
echo ""
color_echo_n "Username:" "green"
color_echo_n " $nome" "white"
echo ""
color_echo_n "Password:" "green"
color_echo_n " $pass" "white"
echo ""
color_echo_n "Limit:" "green"
color_echo_n " $limit" "white"
echo ""
color_echo_n "Validity:" "green"
color_echo_n " $u_temp Minutos" "white"
echo ""
warning_msg "After the user defined time"
color_echo_n "$nome " "green"
color_echo "will be disconnected and deleted." "yellow"
exit
