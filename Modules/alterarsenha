#!/bin/bash

# Load color utility functions
# This provides easy-to-use color functions instead of hardcoded ANSI codes
if [[ -f "/etc/SSHPlus/colors" ]]; then
    source /etc/SSHPlus/colors
elif [[ -f "/bin/colors" ]]; then
    source /bin/colors
elif [[ -f "$(dirname "$0")/colors" ]]; then
    source "$(dirname "$0")/colors"
fi

# Display header
tput setaf 7
tput setab 4
tput bold
printf '%35s%s%-10s\n' "Change User Password"
tput sgr0
echo ""

# Display list header
# Function handles fallback internally, so we can call it directly
color_echo "LIST OF USERS AND THEIR PASSWORDS:" "yellow"
echo ""

_userT=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody)
i=0
unset _userPass
while read _user; do
	i=$(expr $i + 1)
	_oP=$i
	[[ $i == [1-9] ]] && i=0$i && oP+=" 0$i"
	if [[ -e "/etc/SSHPlus/senha/$_user" ]]; then
		_senha="$(cat /etc/SSHPlus/senha/$_user)"
	else
		_senha='Null'
	fi
	# Use color helper functions to build formatted strings for printf
	# Functions handle fallback internally, so we can call them directly
	red_code=$(get_color_code "red")
	cyan_code=$(get_color_code "cyan")
	white_code=$(get_color_code "white")
	green_code=$(get_color_code "green")
	yellow_code=$(get_color_code "yellow")
	reset_code=$(get_reset_code)
	
	suser="${red_code}[${cyan_code}$i${red_code}] ${white_code}- ${green_code}$_user${reset_code}"
	ssenha="${yellow_code}Password${white_code}: $_senha${reset_code}"
    printf '%-60s%s\n' "$suser" "$ssenha"
	_userPass+="\n${_oP}:${_user}"
done <<< "${_userT}"
num_user=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody | wc -l)
echo ""
# Use color functions directly - they handle fallback internally
color_echo_n "Type or select a user " "green"
color_echo_n "[" "yellow"
color_echo_n "1" "cyan"
color_echo_n "-" "red"
color_echo_n "$num_user" "cyan"
color_echo_n "]" "yellow"
color_echo_n ": " "white"
read -r option
user=$(echo -e "${_userPass}" | grep -E "\b$option\b" | cut -d: -f2)
if [[ -z $option ]]
then
	# Use error message function - handles fallback internally
	echo ""
	error_msg "Empty or invalid field!"
	echo ""
	exit 1
elif [[ -z $user ]]
then
	# Use error message function - handles fallback internally
	echo ""
	error_msg "You entered an empty or invalid name!"
	echo ""
	exit 1
else
	if [[ `grep -c /$user: /etc/passwd` -ne 0 ]]
	then
		# Use color functions directly - they handle fallback internally
		echo ""
		color_echo_n "New password for the user " "green"
		color_echo_n "$user" "yellow"
		color_echo_n ": " "white"
		read -r password
		sizepass=$(echo ${#password})
		if [[ $sizepass -lt 4 ]]
		then
			# Use error message function - handles fallback internally
			echo ""
			error_msg "Password empty or invalid! use at least 4 characters"
			echo ""
			exit 1
		else
			ps x | grep $user | grep -v grep | grep -v pt > /tmp/rem
			if [[ `grep -c $user /tmp/rem` -eq 0 ]]
			then
				echo "$user:$password" | chpasswd
				# Use success message function - handles fallback internally
				echo ""
				success_msg "The password for user $user has been changed to: $password"
				echo ""
				echo "$password" > /etc/SSHPlus/senha/$user
				exit 1
			else
				# Use info message function - handles fallback internally
				echo ""
				info_msg "User logged in. Disconnecting..."
				pkill -f $user
				echo "$user:$password" | chpasswd
				# Use success message function - handles fallback internally
				echo ""
				success_msg "The password for user $user has been changed to: $password"
				echo ""
				echo "$password" > /etc/SSHPlus/senha/$user
				exit 1
			fi
		fi
	else
		# Use error message function - handles fallback internally
		echo ""
		error_msg "User $user does not exist!"
		echo ""
	fi
fi