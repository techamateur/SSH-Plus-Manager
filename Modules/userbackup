#!/bin/bash
# userbackup â€“ backup usernames, passwords, limits, expiration dates (menu option [12] BACKUP).

# Load color helpers (install path vs dev path)
if [[ -f /etc/SSHPlus/colors ]]; then
	source /etc/SSHPlus/colors
elif [[ -f /bin/colors ]]; then
	source /bin/colors
elif [[ -f "$(dirname "$0")/colors" ]]; then
	source "$(dirname "$0")/colors"
fi

# Load centralized DB + logging helpers
if [[ -f /etc/SSHPlus/db ]]; then
	source /etc/SSHPlus/db
elif [[ -f /bin/db ]]; then
	source /bin/db
elif [[ -f "$(dirname "$0")/db" ]]; then
	source "$(dirname "$0")/db"
fi

banner_info "            USER BACKUP                 "
echo ""
backup_dir="${HOME:-/root}"
stamp=$(date +%Y%m%d_%H%M%S)
out="${backup_dir}/sshplus_backup_${stamp}.txt"
db="$(sshplus_users_db_path 2>/dev/null || echo "${HOME:-/root}/users.db")"
log="$(sshplus_sessions_log_path 2>/dev/null || echo "${HOME:-/root}/sessions.log")"

{
	echo "# SSHPlus user backup - $stamp"
	echo "# Centralized DB format (space-separated; 8 fields):"
	echo "# username connection_limit expiration_date registration_date total_traffic last_connection_traffic latest_connection_date password"
	echo ""
	echo "## users.db"
	if [[ -f "$db" ]] && [[ -s "$db" ]]; then
		cat "$db"
	else
		echo "# (empty or missing) $db"
	fi
	echo ""
	echo "## sessions.log (last 500 lines)"
	if [[ -f "$log" ]] && [[ -s "$log" ]]; then
		tail -n 500 "$log" 2>/dev/null || cat "$log"
	else
		echo "# (empty or missing) $log"
	fi
} >"$out" 2>/dev/null

if [[ -f "$out" ]] && [[ -s "$out" ]]; then
	msg_ok "Backup saved to: $out"
	color_echo "File: $out" "cyan"
else
	msg_err "Backup file could not be created."
fi
echo ""
sleep 2
