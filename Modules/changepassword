#!/bin/bash
# changepassword â€“ change user password (menu option [06] USER PASSWORD).

# Load color helpers (install path vs dev path)
if [[ -f /etc/SSHPlus/colors ]]; then
	source /etc/SSHPlus/colors
elif [[ -f /bin/colors ]]; then
	source /bin/colors
elif [[ -f "$(dirname "$0")/colors" ]]; then
	source "$(dirname "$0")/colors"
fi

print_header "   Change User Password   "
echo ""
color_echo "LIST OF USERS AND THEIR PASSWORDS:" "yellow"
echo ""

# List only users that currently exist in /etc/passwd
_user_list=$(awk -F: '$3>=1000 {print $1}' /etc/passwd 2>/dev/null | grep -v nobody)
idx=0
unset _userPass
while read -r _user; do
	[[ -z "$_user" ]] && continue
	((idx++)) || true
	[[ $idx -le 9 ]] && i=0$idx || i=$idx
	if [[ -f "/etc/SSHPlus/senha/$_user" ]]; then
		_pass=$(cat "/etc/SSHPlus/senha/$_user" 2>/dev/null)
	else
		_pass='Null'
	fi
	red_code=$(get_color_code "red")
	cyan_code=$(get_color_code "cyan")
	white_code=$(get_color_code "white")
	green_code=$(get_color_code "green")
	yellow_code=$(get_color_code "yellow")
	reset_code=$(get_reset_code)

	suser="${red_code}[${cyan_code}$i${red_code}] ${white_code}- ${green_code}$_user${reset_code}"
	ssenha="${yellow_code}Password${white_code}: $_pass${reset_code}"
	echo -e "${suser}  ${ssenha}"
	_userPass+="\n${i}:${_user}"
done <<< "${_user_list}"
num_user=$(awk -F: '$3>=1000 {print $1}' /etc/passwd 2>/dev/null | grep -v nobody | wc -l)
echo ""
menu_option "0" "BACK" "red" "yellow"
menu_option "00" "EXIT" "red" "yellow"
echo ""
color_echo_n "Type or select a user " "green"
color_echo_n "[" "yellow"
color_echo_n "1" "cyan"
color_echo_n "-" "red"
color_echo_n "$num_user" "cyan"
color_echo_n "]" "yellow"
color_echo_n ": " "white"
read -r option
option="${option//[[:space:]]/}"
# Handle menu navigation
if [[ "$option" == "0" ]]; then
	exit 0
elif [[ "$option" == "00" ]]; then
	exit 99
fi
user=$(echo -e "${_userPass}" | awk -v o="$option" -F: 'NF>=2 && $1+0==o+0 {print $2; exit}')
if [[ -z $option ]]
then
	# Use error message function - handles fallback internally
	echo ""
	error_msg "Empty or invalid field!"
	echo ""
	exit 1
elif [[ -z $user ]]
then
	# Use error message function - handles fallback internally
	echo ""
	error_msg "You entered an empty or invalid name!"
	echo ""
	exit 1
else
	if [[ `grep -c /$user: /etc/passwd` -ne 0 ]]
	then
		# Use color functions directly - they handle fallback internally
		echo ""
		color_echo_n "New password for the user " "green"
		color_echo_n "$user" "yellow"
		color_echo_n ": " "white"
		read -r password
		sizepass=$(echo ${#password})
		if [[ $sizepass -lt 4 ]]
		then
			# Use error message function - handles fallback internally
			echo ""
			error_msg "Password empty or invalid! use at least 4 characters"
			echo ""
			exit 1
		else
			ps x | grep $user | grep -v grep | grep -v pt > /tmp/rem
			if [[ `grep -c $user /tmp/rem` -eq 0 ]]
			then
				echo "$user:$password" | chpasswd
				# Use success message function - handles fallback internally
				echo ""
				success_msg "The password for user $user has been changed to: $password"
				echo ""
				echo "$password" > /etc/SSHPlus/senha/$user
				exit 1
			else
				# Use info message function - handles fallback internally
				echo ""
				info_msg "User logged in. Disconnecting..."
				pkill -f $user
				echo "$user:$password" | chpasswd
				# Use success message function - handles fallback internally
				echo ""
				success_msg "The password for user $user has been changed to: $password"
				echo ""
				echo "$password" > /etc/SSHPlus/senha/$user
				exit 1
			fi
		fi
	else
		# Use error message function - handles fallback internally
		echo ""
		error_msg "User $user does not exist!"
		echo ""
	fi
fi
