#!/usr/bin/env bash
# colors - UI color/styling helpers for SSH Plus Manager
# Goals:
# - consistent (printf, not echo -e)
# - semantic palette (success/warn/danger/info/muted)
# - safe when not a TTY / NO_COLOR / TERM=dumb
# - easy string composition: c "red bold", reset, etc.

# ---------- feature detection ----------
_is_tty() { [[ -t 1 ]]; }
_no_color() {
  [[ -n "${NO_COLOR:-}" ]] && return 0
  [[ "${TERM:-}" == "dumb" || -z "${TERM:-}" ]] && return 0
  !_is_tty && return 0
  return 1
}

# ---------- core codes ----------
ESC=$'\033'
RESET="${ESC}[0m"

BOLD="${ESC}[1m"
DIM="${ESC}[2m"
UNDERLINE="${ESC}[4m"

# Foreground (bright/bold-ish default)
FG_BLACK="${ESC}[30m"
FG_RED="${ESC}[31m"
FG_GREEN="${ESC}[32m"
FG_YELLOW="${ESC}[33m"
FG_BLUE="${ESC}[34m"
FG_MAGENTA="${ESC}[35m"
FG_CYAN="${ESC}[36m"
FG_WHITE="${ESC}[37m"

# Bright foregrounds (better on many dark themes)
FG_BBLACK="${ESC}[90m"
FG_BRED="${ESC}[91m"
FG_BGREEN="${ESC}[92m"
FG_BYELLOW="${ESC}[93m"
FG_BBLUE="${ESC}[94m"
FG_BMAGENTA="${ESC}[95m"
FG_BCYAN="${ESC}[96m"
FG_BWHITE="${ESC}[97m"

# Background
BG_RED="${ESC}[41m"
BG_GREEN="${ESC}[42m"
BG_YELLOW="${ESC}[43m"
BG_BLUE="${ESC}[44m"
BG_MAGENTA="${ESC}[45m"
BG_CYAN="${ESC}[46m"
BG_WHITE="${ESC}[47m"

# ---------- semantic palette (edit here, not everywhere else) ----------
# These are the only "meaning" colors your UI should use.
UI_FRAME="${FG_BBLUE}"           # borders / frame
UI_TITLE="${BOLD}${FG_BWHITE}"   # app title
UI_MUTED="${DIM}${FG_BWHITE}"    # secondary text
UI_LABEL="${FG_BCYAN}"           # labels (Hostname/IP)
UI_VALUE="${FG_BWHITE}"          # values
UI_PROMPT="${BOLD}${FG_BGREEN}"  # prompt

UI_OK="${BOLD}${FG_BGREEN}"      # success
UI_WARN="${BOLD}${FG_BYELLOW}"   # warnings / expiring
UI_DANGER="${BOLD}${FG_BRED}"    # destructive
UI_INFO="${BOLD}${FG_BCYAN}"     # info

# Menu
UI_BRACKET="${FG_BRED}"          # [01]
UI_NUM="${FG_BCYAN}"             # 01
UI_MENU_TXT="${FG_BYELLOW}"      # option label
UI_SECTION="${BOLD}${FG_BCYAN}"  # section headers
UI_SECTION_SYS="${BOLD}${FG_BBLUE}"
UI_SECTION_DANGER="${BOLD}${FG_BRED}"

# ---------- helpers ----------
# c "red bold"  => outputs the escape codes for those tokens
c() {
  _no_color && { printf ""; return 0; }

  local token out=""
  for token in $*; do
    case "$token" in
      reset) out+="${RESET}" ;;
      bold) out+="${BOLD}" ;;
      dim) out+="${DIM}" ;;
      ul|underline) out+="${UNDERLINE}" ;;

      black) out+="${FG_BLACK}" ;;
      red) out+="${FG_BRED}" ;;
      green) out+="${FG_BGREEN}" ;;
      yellow) out+="${FG_BYELLOW}" ;;
      blue) out+="${FG_BBLUE}" ;;
      magenta|purple|rose) out+="${FG_BMAGENTA}" ;;
      cyan) out+="${FG_BCYAN}" ;;
      white) out+="${FG_BWHITE}" ;;
      gray|grey) out+="${FG_BBLACK}" ;;

      bg_red) out+="${BG_RED}" ;;
      bg_green) out+="${BG_GREEN}" ;;
      bg_yellow) out+="${BG_YELLOW}" ;;
      bg_blue) out+="${BG_BLUE}" ;;
      bg_magenta) out+="${BG_MAGENTA}" ;;
      bg_cyan) out+="${BG_CYAN}" ;;
      bg_white) out+="${BG_WHITE}" ;;
    esac
  done
  printf "%s" "$out"
}

reset() { _no_color && printf "" || printf "%s" "$RESET"; }

# Safe printf wrappers
color_echo() {
  local text="$1" color="${2:-white}"
  printf "%b%s%b\n" "$(c "$color")" "$text" "$(reset)"
}
color_echo_n() {
  local text="$1" color="${2:-white}"
  printf "%b%s%b" "$(c "$color")" "$text" "$(reset)"
}

# Keep your old API but improve output format
menu_option() {
  local number="$1" text="$2"
  local bcol="${3:-red}" tcol="${4:-yellow}"
  printf "%b[%b%s%b]%b %s%b\n" \
    "$(c "$bcol")" "$(c cyan)" "$number" "$(c "$bcol")" \
    "$(c "$tcol")" "$text" "$(reset)"
}

error_msg()   { printf "%b✖ %s%b\n" "$(c red bold)" "$1" "$(reset)"; }
success_msg() { printf "%b✔ %s%b\n" "$(c green bold)" "$1" "$(reset)"; }
warning_msg() { printf "%b⚠  %s%b\n" "$(c yellow bold)" "$1" "$(reset)"; }
info_msg()    { printf "%bℹ %s%b\n" "$(c cyan bold)" "$1" "$(reset)"; }

# For building strings: printf "%bfoo%b" "$(get_color_code red)" "$(get_reset_code)"
get_color_code() { c "$1"; }
get_reset_code() { reset; }

# Better headers (no mixed tput + raw sequences)
print_header() {
  local text="$1"
  _no_color && { printf "%s\n" "$text"; return 0; }
  printf "%b%s%b\n" "$(c bg_blue bold white)" "$text" "$(reset)"
}
print_header_red() {
  local text="$1"
  _no_color && { printf "%s\n" "$text"; return 0; }
  printf "%b%s%b\n" "$(c bg_red bold white)" "$text" "$(reset)"
}

# Used by fun_bar / progress bars (returns yellow|red|white|green|reset)
get_progress_colors() {
  printf "%s|%s|%s|%s|%s" "$(c yellow)" "$(c red)" "$(c white)" "$(c green)" "$(reset)"
}

# Color selection menu (used by connections banner/theme)
show_color_menu() {
  printf "\n"
  menu_option "01" "BLUE" "red" "yellow"
  menu_option "02" "GREEN" "red" "yellow"
  menu_option "03" "RED" "red" "yellow"
  menu_option "04" "YELLOW" "red" "yellow"
  menu_option "05" "ROSE" "red" "yellow"
  menu_option "06" "CYAN" "red" "yellow"
  menu_option "07" "ORANGE" "red" "yellow"
  menu_option "08" "PURPLE" "red" "yellow"
  menu_option "09" "BLACK" "red" "yellow"
  menu_option "10" "WITHOUT COLOR" "red" "yellow"
  printf "\n"
}
