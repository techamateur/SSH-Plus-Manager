#!/bin/bash
# menu â€“ main SSH Plus Manager loop; sources colors and runs the main menu.

# Load color helpers (install path vs dev path)
if [[ -f /etc/SSHPlus/colors ]]; then
	source /etc/SSHPlus/colors
elif [[ -f /bin/colors ]]; then
	source /bin/colors
elif [[ -f "$(dirname "$0")/colors" ]]; then
	source "$(dirname "$0")/colors"
fi

# Progress bar function - shows visual progress for long operations
fun_bar() {
	local command1="$1"
	local command2="$2"

	(
		[[ -e $HOME/fim ]] && rm $HOME/fim
		[[ ! -e /usr/lib/sshplus ]] && rm -rf /bin/menu >/dev/null 2>&1
		${command1} -y >/dev/null 2>&1
		${command2} -y >/dev/null 2>&1
		touch $HOME/fim
	) >/dev/null 2>&1 &

	tput civis
	# Use color functions for progress bar
	yellow_code=$(get_color_code "yellow")
	red_code=$(get_color_code "red")
	white_code=$(get_color_code "white")
	green_code=$(get_color_code "green")
	reset_code=$(get_reset_code)

	echo -ne "${yellow_code}["
	while true; do
		for ((i = 0; i < 18; i++)); do
			echo -ne "${red_code}#"
			sleep 0.1s
		done
		[[ -e $HOME/fim ]] && rm $HOME/fim && break
		echo -e "${yellow_code}]"
		sleep 1s
		tput cuu1
		tput dl1
		echo -ne "${yellow_code}["
	done
	echo -e "${yellow_code}]${white_code} -${green_code} OK !${white_code}${reset_code}"
	tput cnorm
}
# Get IP address from config file (with fallbacks; used by subscripts that source menu)
if [[ -f /etc/IP ]] && [[ -s /etc/IP ]]; then
	IP=$(cat /etc/IP)
else
	IP=$(hostname -I 2>/dev/null | awk '{print $1}')
	[[ -z "$IP" ]] && IP=$(wget -qO- --timeout=3 ipv4.icanhazip.com 2>/dev/null)
	[[ -z "$IP" ]] && IP=$(curl -sfL --max-time 3 ipv4.icanhazip.com 2>/dev/null)
	[[ -n "$IP" ]] && echo "$IP" > /etc/IP 2>/dev/null
	[[ -z "$IP" ]] && IP=""
fi

# Ensure wget/curl exist when run as root (for IP and version fetches). Show message if we install.
ensure_fetch_deps() {
	[[ $(id -u) -ne 0 ]] && return 0
	local need=""
	command -v wget &>/dev/null || need="wget"
	command -v curl &>/dev/null || need="${need:+$need }curl"
	[[ -z "$need" ]] && return 0
	apt-get update -qq &>/dev/null
	apt-get install -y wget curl &>/dev/null && echo "Installed missing tools ($need) for IP/version checks." >&2
}

# Main menu function
menu() {
	# Main menu loop - runs until user exits
	while true; do
		green_code=$(get_color_code "green")
		red_code=$(get_color_code "red")

		# Detect operating system version
		if [[ "$(grep -c "Ubuntu" /etc/issue.net 2>/dev/null)" = "1" ]]; then
			system=$(cut -d' ' -f1 /etc/issue.net 2>/dev/null)
			system+=" "
			system+=$(cut -d' ' -f2 /etc/issue.net 2>/dev/null | awk -F "." '{print $1}')
		elif [[ "$(grep -c "Debian" /etc/issue.net 2>/dev/null)" = "1" ]]; then
			system=$(cut -d' ' -f1 /etc/issue.net 2>/dev/null)
			system+=" "
			system+=$(cut -d' ' -f3 /etc/issue.net 2>/dev/null)
		else
			system=$(cut -d' ' -f1 /etc/issue.net 2>/dev/null)
		fi

		# Count online SSH users (excluding root)
		_ons=$(ps -x | grep sshd | grep -v root | grep priv | wc -l)

		# Get expired users count
		if [[ -f /etc/SSHPlus/Exp ]] && [[ -s /etc/SSHPlus/Exp ]]; then
			_expuser=$(cat /etc/SSHPlus/Exp)
		else
			_expuser="0"
		fi

		# Count OpenVPN users
		if [[ -e /etc/openvpn/openvpn-status.log ]]; then
			_onop=$(grep -c "10.8.0" /etc/openvpn/openvpn-status.log 2>/dev/null || echo "0")
		else
			_onop="0"
		fi

		# Count Dropbear users
		if [[ -e /etc/default/dropbear ]]; then
			_drp=$(ps aux | grep dropbear | grep -v grep | wc -l)
			_ondrp=$((_drp - 1))
		else
			_ondrp="0"
		fi

		# Calculate total online users
		_onli=$((_ons + _onop + _ondrp))
		# Get system resource information
		_ram=$(printf ' %-9s' "$(free -h | grep -i mem | awk '{print $2}')")
		_usor=$(printf '%-8s' "$(free -m | awk 'NR==2{printf "%.2f%%", $3*100/$2 }')")
		_usop=$(printf '%-1s' "$(top -bn1 | awk '/Cpu/ { cpu = "" 100 - $8 "%" }; END { print cpu }')")
		_core=$(printf '%-1s' "$(grep -c cpu[0-9] /proc/stat)")
		_system=$(printf '%-14s' "$system")
		_hora=$(printf '%(%H:%M:%S)T')
		_onlin=$(printf '%-5s' "$_onli")
		_userexp=$(printf '%-5s' "$_expuser")
		_tuser=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody | wc -l)

		# Get IPv4 address (persist to /etc/IP when we fetch it)
		if [[ -f /etc/IP ]] && [[ -s /etc/IP ]]; then
			_ipv4=$(tr -d '\r\n' < /etc/IP)
		else
			_ipv4=$(hostname -I 2>/dev/null | awk '{print $1}')
			[[ -z "$_ipv4" ]] && _ipv4=$(wget -qO- --timeout=3 ipv4.icanhazip.com 2>/dev/null)
			[[ -z "$_ipv4" ]] && _ipv4=$(curl -sfL --max-time 3 ipv4.icanhazip.com 2>/dev/null)
			if [[ -z "$_ipv4" ]]; then
				ensure_fetch_deps
				_ipv4=$(wget -qO- --timeout=5 ipv4.icanhazip.com 2>/dev/null)
				[[ -z "$_ipv4" ]] && _ipv4=$(curl -sfL --max-time 5 ipv4.icanhazip.com 2>/dev/null)
			fi
			[[ -n "$_ipv4" ]] && echo "$_ipv4" > /etc/IP 2>/dev/null
			[[ -z "$_ipv4" ]] && _ipv4="N/A"
		fi

		# Get IPv6 address
		_ipv6=$(hostname -I | awk '{for(i=1;i<=NF;i++) if($i ~ /:/) print $i}' | head -1)
		[[ -z "$_ipv6" ]] && _ipv6=$(ip -6 addr show | grep -oE '([0-9a-fA-F]{0,4}:){7}[0-9a-fA-F]{0,4}' | head -1)
		[[ -z "$_ipv6" ]] && _ipv6="N/A"

		# Get hostname and computer name
		_hostname=$(hostname 2>/dev/null || echo "N/A")
		_hostname_short=$(hostname -s 2>/dev/null || echo "N/A")
		_fqdn=$(hostname -f 2>/dev/null || echo "N/A")

		# Check if hostname differs from FQDN
		if [[ "$_hostname" != "$_fqdn" ]] && [[ "$_fqdn" != "N/A" ]]; then
			_hostname_display="${_hostname} (${_fqdn})"
		else
			_hostname_display="$_hostname"
		fi

		# Get network interface stats (upload/download in MB)
		_interface=$(ip route | grep default | awk '{print $5}' | head -1)
		if [[ -n "$_interface" ]] && [[ -f /proc/net/dev ]]; then
			# Get current stats
			_rx_bytes=$(grep "$_interface" /proc/net/dev | awk '{print $2}')
			_tx_bytes=$(grep "$_interface" /proc/net/dev | awk '{print $10}')

			# Convert to MB
			_rx_mb=$(awk "BEGIN {printf \"%.2f\", $_rx_bytes/1024/1024}")
			_tx_mb=$(awk "BEGIN {printf \"%.2f\", $_tx_bytes/1024/1024}")

			# Format: Download/Upload in MB
			_net_download="${_rx_mb}MB"
			_net_upload="${_tx_mb}MB"
			_net_stats="â†“${_net_download} â†‘${_net_upload}"
		else
			_net_download="N/A"
			_net_upload="N/A"
			_net_stats="N/A"
		fi

		# Get disk usage
		_disk_used=$(df -h / | awk 'NR==2 {print $3}')
		_disk_total=$(df -h / | awk 'NR==2 {print $2}')
		_disk_percent=$(df -h / | awk 'NR==2 {print $5}')
		# Used ports (listening)
		_ports=$(ss -tuln 2>/dev/null | awk '/LISTEN/ {gsub(/.*:/,"",$5); print $5}' | sort -nu | tr '\n' ' ')
		[[ -z "$_ports" ]] && _ports=$(netstat -tuln 2>/dev/null | awk '/LISTEN/ {gsub(/.*:/,"",$4); print $4}' | sort -nu | tr '\n' ' ')
		[[ -z "$_ports" ]] && _ports="N/A"

		# Version check for update availability (fetch and persist if missing)
		_ver_repo="${_ver_repo:-https://raw.githubusercontent.com/namnamir/SSH-Plus-Manager/main}"
		[[ -f /etc/SSHPlus/repo_url ]] && [[ -s /etc/SSHPlus/repo_url ]] && _ver_repo=$(tr -d '\r\n' < /etc/SSHPlus/repo_url)
		_ver_local=$(cat /etc/SSHPlus/version 2>/dev/null || cat /bin/version 2>/dev/null)
		_ver_local="${_ver_local:-0}"
		if [[ -z "$_ver_local" ]] || [[ "$_ver_local" == "0" ]]; then
			ensure_fetch_deps
			_ver_fetched=$(wget -qO- --timeout=5 "$_ver_repo/version" 2>/dev/null | head -1 | tr -d '\r\n')
			[[ -z "$_ver_fetched" ]] && _ver_fetched=$(curl -sfL --max-time 5 "$_ver_repo/version" 2>/dev/null | head -1 | tr -d '\r\n')
			if [[ -n "$_ver_fetched" ]]; then
				mkdir -p /etc/SSHPlus
				echo "$_ver_fetched" > /etc/SSHPlus/version 2>/dev/null
				echo "$_ver_fetched" > /bin/version 2>/dev/null
				_ver_local="$_ver_fetched"
			fi
		fi
		[[ -z "$_ver_local" ]] && _ver_local="0"
		_ver_remote=$(wget -qO- --timeout=3 "$_ver_repo/version" 2>/dev/null | head -1 | tr -d '\r\n')
		[[ -z "$_ver_remote" ]] && _ver_remote=$(curl -sfL --max-time 3 "$_ver_repo/version" 2>/dev/null | head -1 | tr -d '\r\n')
		[[ -z "$_ver_remote" ]] && _ver_remote="$_ver_local"
		_ver_update=""
		if [[ -n "$_ver_remote" ]] && [[ "$_ver_local" != "$_ver_remote" ]]; then
			_latest=$(printf '%s\n%s' "$_ver_local" "$_ver_remote" | sort -V 2>/dev/null | tail -1)
			[[ "$_latest" = "$_ver_remote" ]] && _ver_update="$_ver_remote"
		fi

		# Compact header: user traffic sum, uptime, percent parsing
		_user_rx=0 _user_tx=0
		[[ -f /var/lib/SSHPlus/traffic.db ]] && while read -r _ _r _w; do
			_user_rx=$((_user_rx + ${_r:-0})); _user_tx=$((_user_tx + ${_w:-0}))
		done < <(awk '{print $1,$2,$3}' /var/lib/SSHPlus/traffic.db 2>/dev/null)
		_user_down=$(awk -v b="${_user_rx:-0}" 'BEGIN{if(b>=1073741824) printf "%.1fG", b/1073741824; else if(b>=1048576) printf "%.1fM", b/1048576; else if(b>=1024) printf "%.0fK", b/1024; else printf "%dB", b+0}')
		_user_up=$(awk -v b="${_user_tx:-0}" 'BEGIN{if(b>=1073741824) printf "%.1fG", b/1073741824; else if(b>=1048576) printf "%.1fM", b/1048576; else if(b>=1024) printf "%.0fK", b/1024; else printf "%dB", b+0}')
		_sys_down=$(awk "BEGIN {printf \"%.0fM\", ${_rx_bytes:-0}/1024/1024}" 2>/dev/null)
		_sys_up=$(awk "BEGIN {printf \"%.0fM\", ${_tx_bytes:-0}/1024/1024}" 2>/dev/null)
		[[ -z "$_sys_down" || "$_sys_down" = "0M" ]] && _sys_down="${_rx_mb:-0}M"
		[[ -z "$_sys_up" || "$_sys_up" = "0M" ]] && _sys_up="${_tx_mb:-0}M"
		_uptime_short=$(awk '{s=$1; d=int(s/86400); h=int((s%86400)/3600); m=int((s%3600)/60); if(d>0) printf "%dd %02d:%02d", d,h,m; else printf "%02d:%02d", h,m}' /proc/uptime 2>/dev/null)
		[[ -z "$_uptime_short" ]] && _uptime_short=$(uptime -p 2>/dev/null | sed 's/up //;s/ days\?,/d /;s/ hours\?,/:/;s/ minutes\?.*//;s/ //g')
		_n_expiring=0
		for _u in $(awk -F: '$3>=1000 {print $1}' /etc/passwd 2>/dev/null | grep -v nobody); do
			_exp=$(chage -l "$_u" 2>/dev/null | grep "Account expires" | cut -d' ' -f3-)
			[[ "$_exp" = "never" || -z "$_exp" ]] && continue
			_ed=$(date -d "$_exp" +%s 2>/dev/null); _now=$(date +%s)
			_diff=$(( (_ed - _now) / 86400 ))
			[[ $_diff -le 7 && $_diff -gt 0 ]] && ((_n_expiring++)) || true
		done
		_ram_total_short=$(free -m 2>/dev/null | awk 'NR==2{print $2}')
		[[ -n "$_ram_total_short" ]] && _ram_total_short="${_ram_total_short}M" || _ram_total_short=$(free -h 2>/dev/null | awk '/^Mem:/{print $2}')
		_ram_pct=$(echo "${_usor}" | sed 's/%//' | awk '{printf "%.0f", $1+0}')
		_cpu_pct=$(echo "${_usop}" | sed 's/%//' | awk '{printf "%.0f", $1+0}')
		_disk_pct=$(echo "${_disk_percent}" | sed 's/%//' | awk '{printf "%.0f", $1+0}')
		_ram_pct=${_ram_pct:-0}; _cpu_pct=${_cpu_pct:-0}; _disk_pct=${_disk_pct:-0}
		_pct_color() {
			local n="${1:-0}"; [[ "$n" -lt 60 ]] 2>/dev/null && { get_color_code green; return; }; [[ "$n" -lt 85 ]] 2>/dev/null && { get_color_code yellow; return; }; get_color_code red;
		}

		clear

		blue_code=$(get_color_code "blue")
		green_code=$(get_color_code "green")
		red_code=$(get_color_code "red")
		white_code=$(get_color_code "white")
		yellow_code=$(get_color_code "yellow")
		cyan_code=$(get_color_code "cyan")
		reset_code=$(get_reset_code)
		_line="${blue_code}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${reset_code}"
		# Row 1: RAM / CPU / Disk with percent colors (<60 green, 60â€“84 yellow, >=85 red)
		printf " %bğŸ§  RAM %s %b(%s)%b   %bâš™ CPU %sc %b(%s)%b   %bğŸ’¾ Disk %s %b(%s)%b\n" \
			"$cyan_code" "$_ram_total_short" "$(_pct_color "$_ram_pct")" "${_usor}" "$reset_code" \
			"$cyan_code" "$_core" "$(_pct_color "$_cpu_pct")" "${_usop}" "$reset_code" \
			"$cyan_code" "$_disk_total" "$(_pct_color "$_disk_pct")" "$_disk_percent" "$reset_code"
		echo -e "$_line"
		# Row 2: hostname, IP
		printf " %bğŸ–¥ %-20s %bğŸŒ %s %b|%b %s\n" "$white_code" "$_hostname_display" "$cyan_code" "$_ipv4" "$white_code" "$cyan_code" "$_ipv6"
		# Row 3: Sys vs User traffic
		printf " %bğŸŒ Sys â†“%s â†‘%s       %bğŸ“Š User â†“%s â†‘%s  \n" "$cyan_code" "$_sys_down" "$_sys_up" "$cyan_code" "$_user_down" "$_user_up"
		echo ""
		# Row 4: ports
		printf " %bğŸ”Œ %s\n" "$yellow_code" "$_ports"
		echo -e "$_line"
		# Row 5: users (ğŸ‘¤ total ğŸŸ¢on ğŸ”´off âšªexp ğŸŸ¡expiring), uptime, version
		_n_offline=$((_tuser - ${_onli:-0} - ${_expuser:-0}))
		[[ $_n_offline -lt 0 ]] && _n_offline=0
		_expiring_label="$_n_expiring"; [[ $_n_expiring -gt 0 ]] && _expiring_label="$_n_expiring (exp<7d)"
		printf " %bğŸ‘¤ %s   %bğŸŸ¢%s %bğŸ”´%s %bâšª%s %bğŸŸ¡%s%b      %bâ± Uptime: %s   v%s\n" \
			"$yellow_code" "$_tuser" "$green_code" "$_onli" "$red_code" "$_n_offline" "$white_code" "$_expuser" "$yellow_code" "$_expiring_label" "$reset_code" "$cyan_code" "$_uptime_short" "$_ver_local"
		echo -e "$_line"
		if [[ -n "$_ver_update" ]]; then
			printf " %b[!] Update available: v%s â€” use [18] UPDATE SCRIPT%b\n" "$yellow_code" "$_ver_update" "$reset_code"
		fi
		echo ""
		echo -e "${red_code}[${cyan_code}01${red_code}] ${white_code}â€¢ ${yellow_code}CREATE USER ${red_code}     [${cyan_code}09${red_code}] ${white_code}â€¢ ${yellow_code}SPEEDTEST ${reset_code}"
		echo -e "${red_code}[${cyan_code}02${red_code}] ${white_code}â€¢ ${yellow_code}REMOVE USER ${red_code}     [${cyan_code}10${red_code}] ${white_code}â€¢ ${yellow_code}BANNER ${reset_code}"
		echo -e "${red_code}[${cyan_code}03${red_code}] ${white_code}â€¢ ${yellow_code}MONITOR USERS ${red_code}   [${cyan_code}11${red_code}] ${white_code}â€¢ ${yellow_code}VPS TRAFFIC ${reset_code}"
		echo -e "${red_code}[${cyan_code}04${red_code}] ${white_code}â€¢ ${yellow_code}EXPIRATION DATE ${red_code} [${cyan_code}12${red_code}] ${white_code}â€¢ ${yellow_code}BACKUP ${reset_code}"
		echo -e "${red_code}[${cyan_code}05${red_code}] ${white_code}â€¢ ${yellow_code}ACCOUNT LIMIT ${red_code}   [${cyan_code}13${red_code}] ${white_code}â€¢ ${yellow_code}VPS INFO ${reset_code}"
		echo -e "${red_code}[${cyan_code}06${red_code}] ${white_code}â€¢ ${yellow_code}USER PASSWORD ${red_code}   [${cyan_code}14${red_code}] ${white_code}â€¢ ${yellow_code}REBOOT SYSTEM ${reset_code}"
		echo -e "${red_code}[${cyan_code}07${red_code}] ${white_code}â€¢ ${yellow_code}EXPIRED USERS ${red_code}   [${cyan_code}15${red_code}] ${white_code}â€¢ ${yellow_code}RESTART SERVICES ${reset_code}"
		echo -e "${red_code}[${cyan_code}08${red_code}] ${white_code}â€¢ ${yellow_code}CONNECTIONS ${red_code}     [${cyan_code}16${red_code}] ${white_code}â€¢ ${yellow_code}ROOT PASSWORD ${reset_code}"
		echo -e "${red_code}[${cyan_code}17${red_code}] ${white_code}â€¢ ${yellow_code}AUTO RUN ${red_code}        [${cyan_code}18${red_code}] ${white_code}â€¢ ${yellow_code}UPDATE SCRIPT ${reset_code}"
		echo -e "${red_code}[${cyan_code}19${red_code}] ${white_code}â€¢ ${yellow_code}REMOVE SCRIPT ${reset_code}"
		echo ""
		echo -e "${red_code}[${cyan_code}00${red_code}] ${white_code}â€¢ ${yellow_code}EXIT ${green_code}<${yellow_code}<${red_code}<${reset_code}"
		echo ""
		echo -e "${blue_code}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${reset_code}"
		echo ""
		color_echo_n "PLEASE SELECT FROM OPTIONS " "green"
		color_echo_n "?" "yellow"
		color_echo_n "?" "red"
		color_echo_n " : " "white"
		read -r x

		case "$x" in
		1 | 01)
			clear
			createuser
			echo ""
			color_echo_n "Press ENTER to return to menu (copy the user info above first)..." "yellow"
			read -r
			;;
		2 | 02)
			clear
			removeuser
			_ret=$?
			[[ $_ret -eq 99 ]] && exit 0
			sleep 3
			;;
		3 | 03)
			clear
			sshmonitor
			;;
		4 | 04)
			clear
			changeexpiration
			_ret=$?
			[[ $_ret -eq 99 ]] && exit 0
			sleep 3
			;;
		5 | 05)
			clear
			changelimit
			_ret=$?
			[[ $_ret -eq 99 ]] && exit 0
			sleep 3
			;;
		6 | 06)
			clear
			changepassword
			_ret=$?
			[[ $_ret -eq 99 ]] && exit 0
			sleep 3
			;;
		7 | 07)
			clear
			expiredusers
			_ret=$?
			[[ $_ret -eq 99 ]] && exit 0
			;;
		8 | 08)
			connections
			exit 0
			;;
		9 | 09)
			clear
			speedtest
			;;
		10)
			clear
			bannersetup
			;;
		11)
			vpstraffic
			;;
		12)
			clear
			userbackup
			;;
		13)
			clear
			vpsinfo
			;;
		14)
			clear
			rebootsystem
			;;
		15)
			clear
			restartservices
			sleep 5
			;;
		16)
			clear
			rootpassword
			sleep 5
			;;
		17)
			autorun
			;;
		18)
			updatescript
			;;
		19)
			clear
			exec removescript
			;;
		0 | 00)
			# Exit completely
			color_echo "Exiting..." "red"
			sleep 2
			clear
			exit 0
			;;
		*)
			echo ""
			error_msg "Invalid option !"
			sleep 2
			;;
		esac
	done
}
menu
#fim
