#!/bin/bash
# expiredusers â€“ remove expired SSH/OpenVPN users (menu option [06] REMOVE EXPIRED).

# Load color helpers (install path vs dev path)
if [[ -f /etc/SSHPlus/colors ]]; then
	source /etc/SSHPlus/colors
elif [[ -f /bin/colors ]]; then
	source /bin/colors
elif [[ -f "$(dirname "$0")/colors" ]]; then
	source "$(dirname "$0")/colors"
fi

now_sec=$(date +%s)

remove_ovp() {
	local user="$1"
	[[ -e /etc/debian_version ]] && GROUPNAME="nogroup" || GROUPNAME="nobody"
	cd /etc/openvpn/easy-rsa/ || return
	./easyrsa --batch revoke "$user" >/dev/null 2>&1
	./easyrsa gen-crl >/dev/null 2>&1
	rm -rf "pki/reqs/${user}.req" "pki/private/${user}.key" "pki/issued/${user}.crt" 2>/dev/null
	rm -f /etc/openvpn/crl.pem 2>/dev/null
	cp /etc/openvpn/easy-rsa/pki/crl.pem /etc/openvpn/crl.pem 2>/dev/null
	chown nobody:"${GROUPNAME}" /etc/openvpn/crl.pem 2>/dev/null
	[[ -e "$HOME/${user}.ovpn" ]] && rm -f "$HOME/${user}.ovpn" 2>/dev/null
	[[ -e /var/www/html/openvpn/"${user}.zip" ]] && rm -f /var/www/html/openvpn/"${user}.zip" 2>/dev/null
}

clear
menu_option "1" "REMOVE EXPIRED USERS" "red" "yellow"
menu_option "0" "BACK TO MENU" "red" "yellow"
menu_option "00" "EXIT" "red" "yellow"
echo ""
color_echo_n "Select option " "green"
color_echo_n "[1/0/00]: " "white"
read -r resp
[[ "$resp" == "0" || "$resp" == "00" ]] && exit 0
[[ -n "$resp" && "$resp" != "1" ]] && { echo ""; error_msg "Invalid option!"; sleep 2; exit 1; }
echo ""
# Use print_header function for colored header
print_header " User          Date         Status         Action   "
echo ""
for user in $(awk -F: '{print $1}' /etc/passwd 2>/dev/null); do
	expdate=$(chage -l "$user" 2>/dev/null | awk -F: '/Account expires/{print $2}' | xargs)
	[[ -z "$expdate" ]] && continue
	echo "$expdate" | grep -q never && continue
	exp_fmt=$(date -d "$expdate" '+%d/%m/%Y' 2>/dev/null)
	printf "%b%-15s%-17s%b" "$(get_color_code "yellow")" "$user" "$exp_fmt" "$(get_reset_code)"
	expsec=$(date +%s --date="$expdate" 2>/dev/null)
	diff=$((now_sec - expsec))
	if [[ $diff -lt 0 ]]; then
		color_echo "VALID   NOT REMOVED" "green"
		continue
	fi
	color_echo "EXPIRED   WAS REMOVED" "red"
	pkill -f "$user" 2>/dev/null
	userdel --force "$user" 2>/dev/null
	[[ -f /root/users.db ]] && grep -v "^${user}[[:space:]]" /root/users.db > /tmp/ph && mv /tmp/ph /root/users.db
	if [[ -e /etc/openvpn/server.conf ]]; then
		remove_ovp "$user"
	fi
done
echo '0' > /etc/SSHPlus/Exp
echo ""
menu_option "0" "BACK TO MENU" "red" "yellow"
menu_option "00" "EXIT" "red" "yellow"
echo ""
color_echo_n "Select option [0/00]: " "green"
read -r resp
[[ "$resp" == "00" ]] && exit 99
exit 0
