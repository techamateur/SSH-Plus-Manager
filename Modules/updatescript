#!/bin/bash
# updatescript â€“ update manager files from repository (menu option [17] UPDATE SCRIPT).

# Load color helpers (install path vs dev path)
if [[ -f /etc/SSHPlus/colors ]]; then
	source /etc/SSHPlus/colors
elif [[ -f /bin/colors ]]; then
	source /bin/colors
elif [[ -f "$(dirname "$0")/colors" ]]; then
	source "$(dirname "$0")/colors"
fi

banner_info "           UPDATE SCRIPT                "
echo ""

# Repository URL: from config, or from version file when run from repo
repo_url=""
[[ -f /etc/SSHPlus/repo_url ]] && [[ -s /etc/SSHPlus/repo_url ]] && repo_url=$(tr -d '\r\n' < /etc/SSHPlus/repo_url)
if [[ -z "$repo_url" ]]; then
	_upd_ver_file="$(cd "$(dirname "$0")" 2>/dev/null && cd .. 2>/dev/null && pwd)/version"
	[[ -f "$_upd_ver_file" ]] && grep -q '^REPO_URL=' "$_upd_ver_file" 2>/dev/null && repo_url=$(grep '^REPO_URL=' "$_upd_ver_file" 2>/dev/null | head -1 | cut -d= -f2- | tr -d '\r\n')
fi
if [[ -z "$repo_url" ]]; then
	msg_err "Repository URL not configured. Set /etc/SSHPlus/repo_url or run from repo with version file."
	sleep 3
	exec /bin/menu
	exit 0
fi

# Local version: from installed version file (version number only)
local_ver=$(cat /etc/SSHPlus/version 2>/dev/null || cat /bin/version 2>/dev/null)
local_ver="${local_ver//[[:space:]]/}"
[[ -z "$local_ver" ]] && local_ver="0"
# Remote version: fetch version file and parse VERSION= or first line
_rem_ver_raw=$(wget -qO- --timeout=5 "$repo_url/version" 2>/dev/null || curl -sfL --max-time 5 "$repo_url/version" 2>/dev/null)
remote_ver=""
if [[ -n "$_rem_ver_raw" ]]; then
	remote_ver=$(echo "$_rem_ver_raw" | grep '^VERSION=' 2>/dev/null | head -1 | cut -d= -f2- | tr -d '\r\n')
	[[ -z "$remote_ver" ]] && remote_ver=$(echo "$_rem_ver_raw" | head -1 | tr -d '\r\n' | grep -v '^#' | grep -v '^$')
fi
[[ -z "$remote_ver" ]] && remote_ver="$local_ver"

need_update=""
if [[ -n "$remote_ver" ]] && [[ "$local_ver" != "$remote_ver" ]]; then
	latest=$(printf '%s\n%s' "$local_ver" "$remote_ver" | sort -V 2>/dev/null | tail -1)
	[[ "$latest" = "$remote_ver" ]] && need_update=1
fi

color_echo "  Current version: v${local_ver}" "cyan"
color_echo "  Latest version:  v${remote_ver}" "cyan"
echo ""

if [[ -z "$need_update" ]]; then
	msg_ok "Already up to date."
	color_echo_n "Reinstall anyway? [y/N]: " "yellow"
	read -r reinstall
	if [[ ! "$reinstall" =~ ^[Yy]$ ]]; then
		sleep 2
		exec /bin/menu
		exit 0
	fi
	msg_info "Reinstalling all files from repository..."
else
	msg_warn "Update available. This will download all manager files from the repository and overwrite local copies."
	color_echo_n "Continue? [y/N]: " "yellow"
	read -r confirm
	if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
		color_echo "Update cancelled." "green"
		sleep 2
		exec /bin/menu
		exit 0
	fi
fi

[[ -d /etc/SSHPlus ]] || mkdir -p /etc/SSHPlus
tmpdir="/tmp/sshplus_update_$$"
mkdir -p "$tmpdir" || { msg_err "Cannot create temp directory."; sleep 2; exec /bin/menu; exit 1; }

color_echo "Fetching files from repository..." "green"
echo ""

updated=0 failed=0
for spec in "menu:/bin/menu" "changepassword:/bin/changepassword" "createuser:/bin/createuser" "expiredusers:/bin/expiredusers" "changeexpiration:/bin/changeexpiration" "expirationmanager:/bin/expirationmanager" "removeuser:/bin/removeuser" "changelimit:/bin/changelimit" "sshmonitor:/bin/sshmonitor" "connections:/bin/connections" "multiport:/bin/multiport" "userinfo:/bin/userinfo" "serversettings:/bin/serversettings" "bannersetup:/bin/bannersetup" "vpstraffic:/bin/vpstraffic" "vpsinfo:/bin/vpsinfo" "rebootsystem:/bin/rebootsystem" "restartservices:/bin/restartservices" "userbackup:/bin/userbackup" "speedtest:/bin/speedtest" "autorun:/bin/autorun" "updatescript:/bin/updatescript" "removescript:/bin/removescript" "colors:/etc/SSHPlus/colors" "db:/etc/SSHPlus/db" "open.py:/etc/SSHPlus/open.py" "proxy.py:/etc/SSHPlus/proxy.py"; do
	fname="${spec%%:*}"
	dest="${spec##*:}"
	url="${repo_url}/Modules/${fname}"
	tmpf="${tmpdir}/${fname}"
	if wget -q "$url" -O "$tmpf" 2>/dev/null || curl -sfL "$url" -o "$tmpf" 2>/dev/null; then
		if [[ -s "$tmpf" ]]; then
			if cp -f "$tmpf" "$dest" 2>/dev/null; then
				chmod +x "$dest" 2>/dev/null
				((updated++))
				color_echo "  OK: $fname -> $dest" "green"
			else
				((failed++))
				color_echo "  FAIL: $fname (cannot write $dest)" "red"
			fi
		else
			((failed++))
			color_echo "  SKIP: $fname (empty)" "yellow"
		fi
	else
		((failed++))
		color_echo "  FAIL: $fname (download failed)" "red"
	fi
done

rm -rf "$tmpdir" 2>/dev/null

if [[ $updated -gt 0 ]]; then
	echo "$remote_ver" > /etc/SSHPlus/version 2>/dev/null
	echo "$remote_ver" > /bin/version 2>/dev/null
	msg_ok "Update finished: $updated file(s) updated. Version set to v${remote_ver}."
fi
echo ""
[[ $failed -gt 0 ]] && msg_warn "$failed file(s) could not be updated (missing in repo or permission error)."
[[ $updated -eq 0 ]] && [[ $failed -eq 0 ]] && msg_info "No files were changed."
color_echo "To use the new menu, run: menu" "cyan"
sleep 3
exec /bin/menu
