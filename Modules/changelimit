#!/bin/bash
# changelimit â€“ change user connection limit (menu option [05] ACCOUNT LIMIT).

# Load color helpers (install path vs dev path)
if [[ -f /etc/SSHPlus/colors ]]; then
	source /etc/SSHPlus/colors
elif [[ -f /bin/colors ]]; then
	source /bin/colors
elif [[ -f "$(dirname "$0")/colors" ]]; then
	source "$(dirname "$0")/colors"
fi

# Load centralized DB + logging helpers
if [[ -f /etc/SSHPlus/db ]]; then
	source /etc/SSHPlus/db
elif [[ -f /bin/db ]]; then
	source /bin/db
elif [[ -f "$(dirname "$0")/db" ]]; then
	source "$(dirname "$0")/db"
fi

banner_info "   Change limit of simultaneous connections   "
echo ""
color_echo "LIST OF USERS AND THEIR LIMITS:" "yellow"
echo ""
	_user_list=$(awk -F: '$3>=1000 {print $1}' /etc/passwd 2>/dev/null | grep -v nobody)
	idx=0
	unset _userPass
	while read -r _user; do
		[[ -z "$_user" ]] && continue
		((idx++)) || true
		_oP=$idx
		[[ $idx -le 9 ]] && i=0$idx || i=$idx
		_line="$(sshplus_db_get_line "$_user" 2>/dev/null || true)"
		if [[ -z "${_line:-}" ]]; then
			sshplus_with_db_lock sshplus_db_ensure_user "$_user" >/dev/null 2>&1 || true
			_line="$(sshplus_db_get_line "$_user" 2>/dev/null || true)"
		fi
		limit="$(awk '{print $2}' <<<"${_line:-}" 2>/dev/null)"
		[[ -z "${limit:-}" ]] && limit='1'
		red_code=$(get_color_code "red")
		cyan_code=$(get_color_code "cyan")
		white_code=$(get_color_code "white")
		green_code=$(get_color_code "green")
		yellow_code=$(get_color_code "yellow")
		reset_code=$(get_reset_code)

		l_user="${red_code}[${cyan_code}$i${red_code}] ${white_code}- ${green_code}$_user${reset_code}"
		lim="${yellow_code}Limit${white_code}: $limit${reset_code}"
		echo -e "${l_user}  ${lim}"
		_userPass+="\n${i}:${_user}"
	done <<< "${_user_list}"
	echo ""
	num_user=$(awk -F: '$3>=1000 {print $1}' /etc/passwd 2>/dev/null | grep -v nobody | wc -l)
	echo ""
	menu_option "0" "BACK" "red" "yellow"
	menu_option "00" "EXIT" "red" "yellow"
	echo ""
	color_echo_n "Type or select a user " "green"
	color_echo_n "[" "yellow"
	color_echo_n "1" "cyan"
	color_echo_n "-" "red"
	color_echo_n "$num_user" "cyan"
	color_echo_n "]" "yellow"
	color_echo_n ": " "white"
	read -r option
	option="${option//[[:space:]]/}"
	# Handle menu navigation
	if [[ "$option" == "0" ]]; then
		exit 0
	elif [[ "$option" == "00" ]]; then
		exit 99
	fi
	usuario=$(echo -e "${_userPass}" | awk -v o="$option" -F: 'NF>=2 && $1+0==o+0 {print $2; exit}')
    if [[ -z $option ]]; then
		# Use error message function - handles fallback internally
		echo ""
		msg_err "Empty or non-existent user"
		echo ""
		exit
	elif [[ -z $usuario ]]; then
		# Use error message function - handles fallback internally
		echo ""
		msg_err "Empty or non-existent user"
		echo ""
		exit 1
	else
		if cat /etc/passwd |grep -w $usuario > /dev/null; then
			# Use color functions for prompt - functions handle fallback internally
			echo ""
			color_echo_n "New limit for the user " "green"
			color_echo_n "$usuario" "yellow"
			color_echo_n ": " "white"
			read -r sshnum
			if [[ -z $sshnum ]]
			then
				# Use error message function - handles fallback internally
				echo ""
				msg_err "You entered an invalid number!"
				echo ""
				exit 1
			else
				if (echo $sshnum | egrep [^0-9] &> /dev/null)
				then
					# Use error message function - handles fallback internally
					echo ""
					msg_err "You entered an invalid number!"
					echo ""
					exit 1
				else
					if [[ $sshnum -lt 1 ]]
					then
						# Use error message function - handles fallback internally
						echo ""
						msg_err "You must enter a number greater than zero!"
						echo ""
						exit 1
					else
						sshplus_with_db_lock sshplus_db_set_limit "$usuario" "$sshnum" >/dev/null 2>&1 || true
						# Use success message function - handles fallback internally
						echo ""
						msg_ok "Limit applied to user $usuario was $sshnum"
						sleep 2
						exit
					fi
				fi
			fi
		else
			# Use error message function - handles fallback internally
			echo ""
			msg_err "User $usuario not found"
			echo ""
			exit 1
		fi
	fi
fi
