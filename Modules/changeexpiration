#!/bin/bash
# changeexpiration â€“ change user account expiration date (menu option [04] EXPIRATION DATE).

# Load color helpers (install path vs dev path)
if [[ -f /etc/SSHPlus/colors ]]; then
	source /etc/SSHPlus/colors
elif [[ -f /bin/colors ]]; then
	source /bin/colors
elif [[ -f "$(dirname "$0")/colors" ]]; then
	source "$(dirname "$0")/colors"
fi

# Load centralized DB + logging helpers
if [[ -f /etc/SSHPlus/db ]]; then
	source /etc/SSHPlus/db
elif [[ -f /bin/db ]]; then
	source /bin/db
elif [[ -f "$(dirname "$0")/db" ]]; then
	source "$(dirname "$0")/db"
fi

banner_info "   Change expiration date   "
echo ""
color_echo " LIST OF USERS AND EXPIRY DATE:" "yellow"
echo ""
tput setaf 7 ; tput bold
# List only users that currently exist in /etc/passwd
list_user=$(awk -F: '$3>=1000 {print $1}' /etc/passwd 2>/dev/null | grep -v nobody)
idx=0
unset _userPass
while read -r user; do
	((idx++)) || true
	[[ $idx -le 9 ]] && i=0$idx || i=$idx
	# Expiration is managed by the service in $HOME/users.db
	_line="$(sshplus_db_get_line "$user" 2>/dev/null || true)"
	if [[ -z "${_line:-}" ]]; then
		sshplus_with_db_lock sshplus_db_ensure_user "$user" >/dev/null 2>&1 || true
		_line="$(sshplus_db_get_line "$user" 2>/dev/null || true)"
	fi
	expire="$(awk '{print $3}' <<<"${_line:-}" 2>/dev/null)"
	[[ -z "${expire:-}" ]] && expire="never"
	red_code=$(get_color_code "red")
	cyan_code=$(get_color_code "cyan")
	white_code=$(get_color_code "white")
	green_code=$(get_color_code "green")
	yellow_code=$(get_color_code "yellow")
	reset_code=$(get_reset_code)
	if [[ "$expire" == "never" ]]; then
		echo -e "${red_code}[${cyan_code}$i${red_code}] ${white_code}- ${green_code}$user     ${yellow_code}00/00/0000   S/DATE${reset_code}"
	else
		exp_ymd=$(date -d "$expire" +"%Y%m%d" 2>/dev/null)
		today_ymd=$(date +"%Y%m%d" 2>/dev/null)
		exp_fmt=$(date -d "$expire" '+%d/%m/%Y' 2>/dev/null)
		_user="${red_code}[${cyan_code}$i${red_code}] ${white_code}- ${green_code}$user${white_code}${reset_code}"
		if [[ -n "$exp_ymd" && -n "$today_ymd" ]] && [[ "$today_ymd" -ge "$exp_ymd" ]]; then
			expired="${red_code}WON${reset_code}"
			echo -e "${_user}  ${exp_fmt}  ${expired}"
			echo "exp" > /tmp/exp
		else
			ative="${green_code}VALID${reset_code}"
			echo -e "${_user}  ${exp_fmt}  ${ative}"
		fi
	fi
	_userPass+="\n${i}:${user}"
done <<< "${list_user}"
echo ""
if [[ -f /tmp/exp ]]; then
	rm -f /tmp/exp
fi
num_user=$(awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody | wc -l)
echo ""
menu_option "0" "BACK" "red" "yellow"
menu_option "00" "EXIT" "red" "yellow"
echo ""
# Use color functions for prompt
color_echo_n "Type or select a user " "green"
color_echo_n "[" "yellow"
color_echo_n "1" "cyan"
color_echo_n "-" "yellow"
color_echo_n "$num_user" "cyan"
color_echo_n "]" "yellow"
color_echo_n ": " "white"
read -r option
option="${option//[[:space:]]/}"
# Handle menu navigation
if [[ "$option" == "0" ]]; then
	exit 0
elif [[ "$option" == "00" ]]; then
	exit 99
fi
if [[ -z $option ]]
then
	echo ""
	msg_err "Error, Username empty or invalid!"
	exit 1
fi
usuario=$(echo -e "${_userPass}" | awk -v o="$option" -F: 'NF>=2 && $1+0==o+0 {print $2; exit}')
if [[ -z $usuario ]]
then
	echo ""
	msg_err "Error, Username empty or invalid!!!"
	echo ""
	exit 1
else
	if [[ `grep -c /$usuario: /etc/passwd` -ne 0 ]]
	then
	    echo ""
	    # Use color functions for example text
	    color_echo_n "EX:" "red"
	    color_echo_n "(" "yellow"
	    color_echo_n "DATE: " "green"
	    color_echo_n "DAY/MONTH/YEAR " "white"
	    color_echo_n "OR " "yellow"
	    color_echo_n "DAYS: " "green"
	    color_echo_n "30" "white"
	    color_echo ")" "yellow"
	    echo ""
	    color_echo_n "New date or days for the user " "green"
	    color_echo_n "$usuario: " "yellow"
	    color_echo_n "" "white"
	    read -r inputdate
	    inputdate="${inputdate//[[:space:]]/}"
	    if [[ -z "$inputdate" ]]; then
		echo ""
		msg_err "You entered an invalid or non-existent date!"
		echo "Enter a valid date in DAY/MONTH/YEAR format, or a number of days (e.g. 30 or 101)"
		echo "For example: 21/04/2021 or 101"
		echo ""
		exit 1
	    fi
	    # Integer days (e.g. 30, 101)
	    if [[ "$inputdate" =~ ^[0-9]+$ ]]; then
		[[ "$inputdate" -lt 1 ]] && { echo ""; msg_err "Days must be at least 1"; echo ""; exit 1; }
		udata=$(date "+%d/%m/%Y" -d "+${inputdate} days" 2>/dev/null)
		sysdate=$(date "+%Y-%m-%d" -d "+${inputdate} days" 2>/dev/null)
		if [[ -z "$udata" || -z "$sysdate" ]]; then
		    echo ""
		    msg_err "Invalid number of days. Enter a positive integer (e.g. 30 or 101)"
		    echo ""
		    exit 1
		fi
	    else
		# DATE: DAY/MONTH/YEAR
		if [[ "$(echo "$inputdate" | grep -c "/")" -gt 0 ]]; then
		    udata="$inputdate"
		    sysdate="$(echo "$inputdate" | awk -v FS=/ -v OFS=- '{print $3,$2,$1}')"
		else
		    echo ""
		    msg_err "You entered an invalid or non-existent date!"
		    echo "Use DAY/MONTH/YEAR (e.g. 21/04/2021) or a number of days (e.g. 101)"
		    echo ""
		    exit 1
		fi
		if ! date "+%Y-%m-%d" -d "$sysdate" >/dev/null 2>&1; then
		    echo ""
		    msg_err "You entered an invalid or non-existent date!"
		    echo "Enter a valid date in DAY/MONTH/YEAR format"
		    echo "For example: 21/04/2021"
		    echo ""
		    exit 1
		fi
	    fi
	    # Check future date
	    today="$(date -d today +"%Y%m%d")"
	    timemachine="$(date -d "$sysdate" +"%Y%m%d")"
	    if [[ "$today" -ge "$timemachine" ]]; then
		echo ""
		msg_err "You entered a past date or the current day!"
		echo "Enter a future date (DAY/MONTH/YEAR) or a number of days (e.g. 101)"
		echo "For example: 21/04/2021 or 30"
		echo ""
		exit 1
	    fi
	    chage -E "$sysdate" "$usuario"
	    sshplus_with_db_lock sshplus_db_set_expiration "$usuario" "$sysdate" >/dev/null 2>&1 || true
	    echo ""
	    msg_ok "User Success $usuario new date: $udata"
	    echo ""
	    exit 0
	else
		echo ""
		msg_err "The user $usuario does not exist!"
		echo ""
		exit 1
	fi
fi
