**Language / زبان:** [English](TROUBLESHOOTING.md) | [فارسی](TROUBLESHOOTING.fa.md)

<div dir="rtl">

# SSH Plus Manager — رفع مشکلات

مشکلات رایج و کارهایی که باید انجام دهید.

---

## نصب و اولین اجرا

### بعد از نصب: `menu: command not found`

نصب‌کننده منو را در `/bin/menu` قرار می‌دهد. اگر `PATH` شما `/bin` را شامل نیست، اجرا کنید:

<div dir="ltr">

```bash
/bin/menu
```

</div>

یا `/bin` را به PATH اضافه کنید، یا یک نام دیگر تعریف کنید:

<div dir="ltr">

```bash
alias menu='/bin/menu'
```

</div>

### موقع نصب: `curl: command not found` یا `wget: command not found`

نصب تک‌خطی به یکی از `curl` یا `wget` نیاز دارد. اول یکی را نصب کنید:

- **Debian/Ubuntu:**  
  `apt update && apt install -y curl`  
  یا  
  `apt install -y wget`
- **CentOS/RHEL:**  
  `yum install -y curl`  
  یا  
  `yum install -y wget`

بعد دوباره دستور نصب را با curl یا wget مناسب اجرا کنید.

### اسکریپت می‌گوید «Could not fetch version file» یا نسخه به صورت `v0` است

- نصب‌کننده برای دانلود فایل **version** از مخزن به اینترنت نیاز دارد. اگر دانلود ناموفق باشد، نسخه ۰ می‌ماند و بررسی بروزرسانی درست کار نمی‌کند.
- مطمئن شوید سرور به `https://raw.githubusercontent.com` دسترسی دارد (و `curl` یا `wget` دارید).  
  در صورت پروکسی یا فایروال، ابتدا آن را درست کنید.
- پس از نصب یا بروزرسانی موفق، نسخه در `/etc/SSHPlus/version` و `/bin/version` ذخیره می‌شود. در صورت نیاز دستی قرار دهید، مثلاً:  
  `echo "1.0.8" | sudo tee /etc/SSHPlus/version /bin/version`

---

## IP و بنر

### IPv4 یا IP در منو یا در «SSH ACCOUNT CREATED» خالی است

- مدیر ابتدا از `/etc/IP` استفاده می‌کند. این فایل توسط نصب‌کننده (یا **Install/list**) از طریق سرویس «IP من چیست» پر می‌شود.
- اگر خالی یا اشتباه است:
  - اتصال اینترنت خروجی سرور و دسترسی به مثلاً `ipv4.icanhazip.com` یا `whatismyip.akamai.com` را بررسی کنید.
  - **wget** یا **curl** نصب باشد (نصب‌کننده آن‌ها را نصب می‌کند). اگر نبود:  
    `apt install -y wget curl`
- می‌توانید `/etc/IP` را دستی پر کنید:  
  `echo "YOUR.SERVER.IP" | sudo tee /etc/IP`

### بنر یا صفحه «Create user» فقط «IP:» نشان می‌دهد و بعدش چیزی نیست

مشکل همان است: اسکریپت از `/etc/IP` می‌خواند. طبق بخش قبل آن را پر کنید.

---

## سرعت‌سنج [09]

### [09] سرعت‌سنج فوراً بسته می‌شود یا خطا می‌دهد

- **[09]** از **speedtest-cli** استفاده می‌کند. اگر نباشد، منو سعی به نصب (pip یا apt) می‌کند و سپس از شما Enter می‌خواهد. اگر نصب ناموفق بود پیشنهاد می‌دهد:  
  `pip3 install speedtest-cli`  
  یا  
  `apt install speedtest-cli`
- در صورت نیاز با root نصب کنید:  
  `pip3 install speedtest-cli`  
  یا  
  `apt install -y speedtest-cli`
- اگر speedtest-cli اجرا می‌شود ولی خروجی نمی‌دهد، احتمالاً سرور به speedtest.net دسترسی ندارد. اتصال خروجی را بررسی کرده دوباره امتحان کنید.

### سرعت‌سنج «Error output» یا «Check connectivity to speedtest.net» نشان می‌دهد

- اسکریپت خطای خود speedtest-cli را نشان می‌دهد. دلیل‌های معمول:
  - فایروال یا شبکه دسترسی به speedtest.net را مسدود کرده.
  - VPS اتصال خروجی ندارد.
  - محدودیت یا قطعی موقت سرویس.  
  بعداً یا از شبکه دیگری دوباره امتحان کنید.

---

## کاربران و محدودیت‌ها

### «ایجاد کاربر» یا «حذف کاربر» کاربری را که انتظار دارم نشان نمی‌دهد

- لیست کاربران از حساب‌های فعلی سیستم و دیتابیس مرکزی `$HOME/users.db` ساخته می‌شود. اگر کاربر را در سطح سیستم حذف کرده‌اید (مثلاً `userdel`)، ممکن است تا زمانی که مدیر آن را به‌روز کند هنوز رکوردی از او در `$HOME/users.db` بماند (مثلاً بعد از «حذف کاربر» یا «حذف کاربران منقضی‌شده»).

### به نظر تغییر رمز یا محدودیت اعمال نشده

- **رمز:** اسکریپت از `chpasswd` استفاده می‌کند. مطمئن شوید به نشست قدیمی نگاه نمی‌کنید؛ در ترمینال جدید دوباره ورود کنید.
- **محدودیت اتصال:** محدودیت در `$HOME/users.db` (منبع واحد حقیقت) ذخیره می‌شود و توسط منطق مدیر اعمال می‌شود.

---

## SSH، پورت‌ها و فایروال (چند پورت / UFW)

### پورت‌های SSH را در منو اضافه کردم ولی هنوز وصل نمی‌شوم

- **UFW:** اگر UFW روشن است، هر پورت SSH باید در آن مجاز باشد. ابزار چند پورت فرض می‌کند UFW هست؛ اگر UFW نصب نباشد، اسکریپت ادامه نمی‌دهد.
- **پورت در سه جا:** برای کار کردن چند پورت SSH نیاز دارید:
  1. **sshd_config** — یک خط `Port` برای هر پورت.
  2. **systemd** — `ssh.socket` (یا معادل) روی آن پورت‌ها گوش دهد (مثلاً با `ListenStream` در override).
  3. **UFW** — `ufw allow <port>/tcp` برای هر پورت.

اگر یکی از این سه نادرست یا ناقص باشد، آن پورت کار نمی‌کند. برای روش کامل ببینید: **[SSH-MULTIPORT.fa.md](SSH-MULTIPORT.fa.md)**.

### موقع اضافه کردن پورت: «Configuration validation failed» یا «Invalid SSH configuration»

- اسکریپت چند پورت برای بررسی تنظیمات `sshd -t` (یا مشابه) را اجرا می‌کند. اگر خطا دهد ممکن است تغییرات برگردانده شود.
- دلیل‌های معمول:
  - **پورت از قبل استفاده می‌شود** — پورتی را که از قبل در `sshd_config` یا واحد سوکت هست اضافه نکنید.
  - **خط Port تکراری** — هر پورت فقط یک بار.
  - **پوشه‌های لازم نیست** — مثلاً «Missing privilege separation directory: /run/sshd». در صورت نیاز بسازید:  
    `mkdir -p /run/sshd && chmod 0755 /run/sshd`
- بر اساس پیام دقیق خطا درست کنید، سپس خودتان `sshd -t` بزنید. وقتی هیچ خروجی نداد، تنظیمات درست است.

### بعد از عوض کردن پورت SSH دیگر دسترسی ندارم

- اگر پورت اصلی SSH را عوض کرده و در فایروال مجاز نکرده‌اید، یا پورت قدیمی را پیش از اطمینان از کار کردن پورت جدید بسته‌اید، ممکن است دسترسی از دست برود.
- **پیشگیری:** از جریان *افزودن* پورت استفاده کنید تا SSH روی ۲۲ (یا پورت فعلی) بماند و فقط پورت‌های جدید *اضافه* شوند. پورت جدید را در UFW مجاز کنید و تست کنید. فقط وقتی مطمئن شدید پورت جدید کار می‌کند، پورت قدیمی را حذف یا عوض کنید.
- **بازیابی:** از «Console» یا «Recovery» (VNC/دسترسی خارج‌باندی) ارائه‌دهنده استفاده کنید و `sshd_config`، systemd و UFW را درست کنید یا از پشتیبان بازیابی کنید.

---

## بروزرسانی و وابستگی‌ها

### در [18] بروزرسانی اسکریپت: «Current version: v0» و «Latest version: v0»

- نسخه از `/etc/SSHPlus/version` یا `/bin/version` خوانده می‌شود و «آخرین» از فایل **version** مخزن گرفته می‌شود.
- اگر هر دو ۰ باشد، یا فایل‌های نسخه نصب‌شده خالی/غایب‌اند، یا سرور به مخزن (مثلاً `raw.githubusercontent.com`) دسترسی ندارد.
- راه‌حل: اطمینان از کار کردن HTTPS خروجی و نصب **wget**/**curl**. بعد [18] را دوباره بزنید، یا طبق بخش «Script says Could not fetch version file» بالا نسخه را دستی قرار دهید.

### موقع نصب: «Could not install: …»

- نصب‌کننده برای وابستگی‌ها از `apt install` استفاده می‌کند. اگر بسته‌ای پیدا نشد یا خطا داد، در انتها فهرست می‌شود.
- خودتان نصب کنید، مثلاً:  
  `apt update && apt install -y wget curl bc screen nano unzip zip lsof net-tools dos2unix nload jq figlet python3 python3-pip`
- **speedtest-cli** با apt و در صورت شکست با pip امتحان می‌شود. اگر هر دو ناموفق بودند، دستی نصب کنید:  
  `pip3 install speedtest-cli`

### خطای رنگ یا «command not found» برای `get_color_code`، `banner_info` و نظیر آن

- این‌ها از ماژول **colors** می‌آیند. منو آن را از `/etc/SSHPlus/colors` یا `/bin/colors` بار می‌کند.
- اگر منو را از کپیِ نصب‌نشده با نصب‌کننده اجرا کنید (مثلاً فقط چند فایل زیر `/bin`)، ممکن است colors نباشد.  
  نصب‌کننده یا **[18] بروزرسانی اسکریپت** را دوباره اجرا کنید تا همه ماژول‌ها (از جمله colors) در `/bin` یا `/etc/SSHPlus` قرار گیرند.

---

## چند پورت SSH و UFW (مرجع)

برای مراحل تفصیلی:

- مجاز کردن پورت‌های SSH در UFW (مثلاً ۲۲، ۳۳۹۸، ۴۴۳، ۸۰، ۸۰۸۰، ۸۴۴۳، ۵۳، ۹۹۳، ۹۹۵)
- ویرایش `sshd_config` و systemd یعنی `ssh.socket`
- بارگذاری مجدد systemd و بررسی گوش دادن SSH روی پورت‌های درست

ببینید **[SSH-MULTIPORT.fa.md](SSH-MULTIPORT.fa.md)**.

وقتی UFW هست، نصب‌کننده چند پورت را مجاز می‌کند (مثلاً ۴۴۳، ۸۰، ۳۱۲۸، ۸۷۹۹، ۸۰۸۰). برای **چند پورت SSH** باید هر پورت SSH که استفاده می‌کنید صریحاً مجاز باشد، مثلاً:

<div dir="ltr">

```bash
ufw allow 22/tcp
ufw allow 3398/tcp
ufw allow 443/tcp
ufw allow 80/tcp
ufw allow 8080/tcp
ufw allow 8443/tcp
ufw allow 53/tcp
ufw allow 993/tcp
ufw allow 995/tcp
ufw reload
```

</div>

---

## نوشته‌های مرتبط

- **مخزن:** [namnamir/SSH-Plus-Manager](https://github.com/namnamir/SSH-Plus-Manager)
- **استفاده و گزینه‌ها:** [USAGE.fa.md](USAGE.fa.md)
- **چند پورت SSH و UFW:** [SSH-MULTIPORT.fa.md](SSH-MULTIPORT.fa.md)

</div>
